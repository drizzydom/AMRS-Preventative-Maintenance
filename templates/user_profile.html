{% extends "base.html" %}

{% block title %}Profile - {{ current_user.username }}{% endblock %}

{% block header_title %}My Profile{% endblock %}

{% block content %}
<!-- Set default preferences at the beginning of the template using Jinja's built-in tests -->
{% if current_user.notification_preferences is defined and current_user.notification_preferences is not none %}
    {% set preferences = current_user.notification_preferences %}
{% else %}
    {% set preferences = {'enable_email': True, 'email_frequency': 'weekly', 'notification_types': ['overdue', 'due_soon']} %}
{% endif %}

<div class="user-profile">
    <!-- Personal Information -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Personal Information</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('update_profile') }}">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="username" class="form-label">Username</label>
                            <input type="text" id="username" name="username" class="form-control" 
                                   value="{{ current_user.username }}" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" id="email" name="email" class="form-control" 
                                   value="{{ current_user.email or '' }}" required>
                            <small class="form-text">Used for account recovery and notifications</small>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="full_name" class="form-label">Full Name</label>
                    <input type="text" id="full_name" name="full_name" class="form-control" 
                           value="{{ current_user.full_name or '' }}">
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </form>
        </div>
    </div>
    
    <!-- Security Settings -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Security</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('change_password') }}" id="passwordForm">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="current_password" class="form-label">Current Password</label>
                            <input type="password" id="current_password" name="current_password" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="new_password" class="form-label">New Password</label>
                            <input type="password" id="new_password" name="new_password" class="form-control" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="confirm_password" class="form-label">Confirm New Password</label>
                            <input type="password" id="confirm_password" name="confirm_password" class="form-control" required>
                        </div>
                    </div>
                </div>

                <div class="password-requirements mt-2">
                    <div class="requirement" id="length-requirement">
                        <i class="fas fa-circle"></i>
                        At least 8 characters long
                    </div>
                    <div class="requirement" id="uppercase-requirement">
                        <i class="fas fa-circle"></i>
                        Contains at least 1 uppercase letter
                    </div>
                    <div class="requirement" id="number-requirement">
                        <i class="fas fa-circle"></i>
                        Contains at least 1 number
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </form>
        </div>
    </div>
    
    <!-- Notification Preferences -->
    <div class="card">
        <div class="card-header">
            <h3>Notification Preferences</h3>
        </div>
        <div class="card-body">
            <form method="POST" action="{{ url_for('update_notification_preferences') }}">
                <div class="form-group">
                    <div class="d-flex align-items-center mb-3">
                        <input type="checkbox" id="enable_email" name="enable_email" 
                               {% if preferences.get('enable_email', True) %}checked{% endif %} class="mr-2">
                        <label for="enable_email" class="form-label mb-0 ml-2">
                            Receive email notifications
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="email-frequency-group">
                    <label class="form-label">Email Notification Frequency</label>
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="email_frequency" id="email-immediate" 
                                  value="immediate" {% if preferences.get('email_frequency') == 'immediate' %}checked{% endif %}>
                            <label class="form-check-label" for="email-immediate">
                                Immediate - Send notifications as soon as maintenance is due
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="email_frequency" id="email-daily" 
                                  value="daily" {% if preferences.get('email_frequency') == 'daily' %}checked{% endif %}>
                            <label class="form-check-label" for="email-daily">
                                Daily Digest - Send one email per day with all due items
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="email_frequency" id="email-weekly" 
                                  value="weekly" {% if not preferences.get('email_frequency') or preferences.get('email_frequency') == 'weekly' %}checked{% endif %}>
                            <label class="form-check-label" for="email-weekly">
                                Weekly Summary - Send one email per week with all due items
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group mt-3">
                    <label class="form-label">Notification Types</label>
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify-overdue" name="notification_types" 
                                   value="overdue" {% if 'overdue' in preferences.get('notification_types', ['overdue', 'due_soon']) %}checked{% endif %}>
                            <label class="form-check-label" for="notify-overdue">
                                Overdue Maintenance - Items past their due date
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify-due-soon" name="notification_types" 
                                   value="due_soon" {% if 'due_soon' in preferences.get('notification_types', ['overdue', 'due_soon']) %}checked{% endif %}>
                            <label class="form-check-label" for="notify-due-soon">
                                Due Soon - Items within the notification threshold
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="notify-completion" name="notification_types" 
                                   value="completion" {% if 'completion' in preferences.get('notification_types', []) %}checked{% endif %}>
                            <label class="form-check-label" for="notify-completion">
                                Completion Notifications - When maintenance is recorded by other users
                            </label>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-bell"></i> Save Notification Preferences
                </button>
            </form>
        </div>
    </div>
</div>

<style>
    .password-requirements {
        margin: 0.5rem 0 1rem;
        padding: 1rem;
        background-color: var(--gray-50);
        border-radius: 0.375rem;
    }
    
    .requirement {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
        color: var(--gray-600);
        font-size: 0.875rem;
    }
    
    .requirement i {
        margin-right: 0.5rem;
        font-size: 0.75rem;
    }
    
    .requirement.valid {
        color: var(--success-color);
    }
    
    .requirement.invalid {
        color: var(--gray-500);
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Password validation
        const passwordField = document.getElementById('new_password');
        const confirmField = document.getElementById('confirm_password');
        const lengthReq = document.getElementById('length-requirement');
        const uppercaseReq = document.getElementById('uppercase-requirement');
        const numberReq = document.getElementById('number-requirement');
        const form = document.getElementById('passwordForm');
        
        function updateRequirements() {
            const password = passwordField.value;
            
            // Check length
            if (password.length >= 8) {
                lengthReq.classList.add('valid');
                lengthReq.classList.remove('invalid');
                lengthReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                lengthReq.classList.add('invalid');
                lengthReq.classList.remove('valid');
                lengthReq.querySelector('i').className = 'fas fa-circle';
            }
            
            // Check uppercase
            if (/[A-Z]/.test(password)) {
                uppercaseReq.classList.add('valid');
                uppercaseReq.classList.remove('invalid');
                uppercaseReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                uppercaseReq.classList.add('invalid');
                uppercaseReq.classList.remove('valid');
                uppercaseReq.querySelector('i').className = 'fas fa-circle';
            }
            
            // Check number
            if (/\d/.test(password)) {
                numberReq.classList.add('valid');
                numberReq.classList.remove('invalid');
                numberReq.querySelector('i').className = 'fas fa-check-circle';
            } else {
                numberReq.classList.add('invalid');
                numberReq.classList.remove('valid');
                numberReq.querySelector('i').className = 'fas fa-circle';
            }
        }
        
        passwordField.addEventListener('input', updateRequirements);
        
        form.addEventListener('submit', function(e) {
            const password = passwordField.value;
            
            // Validate password
            if (password.length < 8 || !/[A-Z]/.test(password) || !/\d/.test(password)) {
                e.preventDefault();
                alert('Please ensure your password meets all requirements.');
                return;
            }
            
            // Check if passwords match
            if (passwordField.value !== confirmField.value) {
                e.preventDefault();
                alert('Passwords do not match. Please try again.');
                return;
            }
        });
        
        // Toggle email frequency options based on email notifications enabled/disabled
        const enableEmailCheckbox = document.getElementById('enable_email');
        const emailFrequencyGroup = document.getElementById('email-frequency-group');
        
        enableEmailCheckbox.addEventListener('change', function() {
            emailFrequencyGroup.style.display = this.checked ? 'block' : 'none';
        });
        
        // Initialize email frequency visibility
        emailFrequencyGroup.style.display = enableEmailCheckbox.checked ? 'block' : 'none';
    });
</script>
{% endblock %}
