{% extends "base.html" %}

{% block title %}Audit History - Maintenance Tracker{% endblock %}

{% block header_title %}Audit History{% endblock %}

{% block content %}
<!-- Flashed messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container-fluid">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not (current_user.is_admin or (current_user.is_authenticated and current_user.role and (
    (hasattr(current_user.role, 'name') and 'audits.access' in (current_user.role.permissions or '')) or
    (not hasattr(current_user.role, 'name') and Role.query.filter_by(name=current_user.role).first() and 'audits.access' in (Role.query.filter_by(name=current_user.role).first().permissions or ''))
))) %}
  <div class="alert alert-warning text-center my-4" role="alert">
      <h4 class="alert-heading">Audits Feature Not Enabled</h4>
      <p>This feature is not available in your current plan. If you would like access to the Audits module, please contact <a href="mailto:sales@accuratemachinerepair.com">sales@accuratemachinerepair.com</a> for more information.</p>
  </div>
{% else %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">Audit History</h2>
                <div class="d-print-none">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4 d-print-none">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% if show_site_dropdown %}
                        <div class="col-md-3">
                            <label for="site_id" class="form-label">Site</label>
                            <select class="form-select" id="site_id" name="site_id" onchange="updateMachines(this.value)">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <!-- Hidden site_id field when only one site is available -->
                        <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
                        {% endif %}
                        
                        <div class="col-md-3">
                            <label for="machine_id" class="form-label">Machine</label>
                            <select class="form-select" id="machine_id" name="machine_id">
                                <option value="">All Machines</option>
                                {% for machine in available_machines %}
                                <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %} d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>

            {% block print_view %}
            <div class="d-print-block">
                <div class="print-header">
                    <div class="company-info">
                        <h1>AMRS Preventative Maintenance</h1>
                        <p>Machine Audit History Report</p>
                    </div>
                    <div class="report-title">
                        <h2>Audit History Report</h2>
                        <span class="report-id">Generated on {{ current_date }}</span>
                    </div>
                    <div class="report-meta">
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Date Range:</th>
                                    <td>{{ start_date }} to {{ end_date }}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>{{ current_user.full_name }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Total Machines:</th>
                                    <td>{{ machines|length }}</td>
                                </tr>
                                <tr>
                                    <th>Total Records:</th>
                                    <td>{{ total_records }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                {% for machine in machines %}
                <div class="machine-section">
                    <div class="machine-title">
                        {{ machine.name }} ({{ machine.machine_id }})
                    </div>
                    {% if machine_data[machine.id] %}
                        {% set date_range = get_date_range(start_date, end_date) %}
                        <!-- Begin Calendar View -->
                        <div class="calendar-grid excel-calendar">
                            <!-- Calendar Headers (Days of Week) -->
                            <div class="calendar-row">
                                <div class="calendar-heading">Sunday</div>
                                <div class="calendar-heading">Monday</div>
                                <div class="calendar-heading">Tuesday</div>
                                <div class="calendar-heading">Wednesday</div>
                                <div class="calendar-heading">Thursday</div>
                                <div class="calendar-heading">Friday</div>
                                <div class="calendar-heading">Saturday</div>
                            </div>
                            <!-- Calendar Days -->
                            {% for week in get_calendar_weeks(start_date, end_date) %}
                            <div class="calendar-row">
                                {% for date in week %}
                                    <div class="calendar-day{% if date == current_date %} today{% endif %}">
                                        {% if date %}
                                            <div class="calendar-date">{{ date.day }}</div>
                                            <div class="calendar-entries">
                                                {% set date_str = date.strftime('%Y-%m-%d') %}
                                                {% if date_str in machine_data[machine.id] %}
                                                    {% for audit in machine_data[machine.id][date_str] %}
                                                        <div class="audit-entry">
                                                            <div class="audit-time">{{ audit.created_at.strftime('%H:%M') }}</div>
                                                            <div class="audit-task">{{ audit.task_name }}</div>
                                                            <div class="audit-user">{{ audit.user_name }}</div>
                                                        </div>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        <!-- End Calendar View -->
                    {% else %}
                        <div class="no-data">
                            No audit records found for this machine in the selected date range.
                        </div>
                    {% endif %}
                    <!-- Certification Footer -->
                    <div class="certification-footer">
                        This document certifies that all recorded maintenance tasks have been performed according to 
                        AMRS Preventative Maintenance standards and protocols. Report ID: {{ report_id }}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endblock %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store machine data in a JavaScript variable
    // This completely separates Jinja template logic from JavaScript
    var machineData = [
        {% for machine in available_machines %}
            {% if machine.site_id is defined %}
            {
                id: "{{ machine.id }}",
                name: "{{ machine.name|replace('"', '\\"')|replace("'", "\\'") }}",
                siteId: "{{ machine.site_id }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];
    
    // Store the selected values in JavaScript variables
    var selectedSiteId = "{{ sites[0].id if sites and not show_site_dropdown else selected_site|default('') }}";
    var selectedMachineId = "{{ selected_machine|default('') }}";
    
    // Function to update available machines when site selection changes
    function updateMachines(siteId) {
        // Get the machine dropdown
        const machineDropdown = document.getElementById('machine_id');
        
        // Clear current options except for the "All Machines" option
        while (machineDropdown.options.length > 1) {
            machineDropdown.remove(1);
        }
        
        // If no site selected, we're done (keep just "All Machines" option)
        if (!siteId) {
            return;
        }
        
        // Add machines for the selected site
        machineData.forEach(function(machine) {
            if (machine.siteId === siteId) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            }
        });
        
        // If we have a previously selected machine, try to restore it
        if (selectedMachineId) {
            for (let i = 0; i < machineDropdown.options.length; i++) {
                if (machineDropdown.options[i].value === selectedMachineId) {
                    machineDropdown.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Initialize the machine dropdown when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const siteDropdown = document.getElementById('site_id');
        if (siteDropdown && siteDropdown.value) {
            updateMachines(siteDropdown.value);
        }
    });

    // Enhanced print handling
    window.onbeforeprint = function() {
        // Force page to landscape orientation for better calendar layout
        const forceLandscape = document.createElement('style');
        forceLandscape.type = 'text/css';
        forceLandscape.innerHTML = `
            @page { 
                size: landscape !important; 
                margin: 0.4in !important; 
                margin-bottom: 0.6in !important; /* Extra space for the footer certification */
            }
            
            /* Create excel-like calendar tables */
            .calendar-grid {
                display: table !important;
                width: 100% !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
            }
            
            .calendar-row {
                display: table-row !important;
            }
            
            .calendar-day {
                display: table-cell !important;
                border: 1px solid #666 !important;
                width: calc(100% / 7) !important;
                vertical-align: top !important;
            }
            
            /* Force machine sections to have page breaks between them */
            .machine-section {
                page-break-after: always !important;
                page-break-inside: avoid !important;
                display: block !important;
                width: 100% !important;
                margin-bottom: 1.5in !important; /* Space for the certification */
                position: relative !important;
            }
            
            /* Last machine section doesn't need a page break after */
            .machine-section:last-child {
                page-break-after: auto !important;
            }
            
            /* Make sure the certification appears at the bottom of each page */
            .certification-footer {
                position: running(footer) !important;
                font-size: 7pt !important;
                text-align: center !important;
                border-top: 1px solid #999 !important;
                padding-top: 5px !important;
            }
            
            @page {
                @bottom-center {
                    content: element(footer) !important;
                }
            }
            
            /* Ensure color backgrounds print */
            .calendar-date, .machine-title, .calendar-day, .calendar-heading, .today-cell {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* Special color for today's date in the calendar */
            .today-cell {
                background-color: #e8f4f8 !important;
            }
            
            /* Fixed headers for calendar */
            .calendar-heading {
                font-weight: bold !important;
                background-color: #d9d9d9 !important; /* Excel-like header color */
                padding: 4px !important;
                text-align: center !important;
                border: 1px solid #666 !important;
            }
            
            /* Fix for print visibility */
            body * {
                visibility: hidden !important;
                display: none !important;
            }
            
            .d-none.d-print-block, 
            .d-none.d-print-block * {
                visibility: visible !important;
                display: block !important;
            }
            
            .d-print-table {
                display: table !important;
            }
            
            .d-print-table-row {
                display: table-row !important;
            }
            
            .d-print-table-cell {
                display: table-cell !important;
            }
            
            html body .content-container {
                margin-left: 0 !important;
                width: 100% !important;
                max-width: 100% !important;
                padding: 0 !important;
            }
        `;
        document.head.appendChild(forceLandscape);
    };
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    @media print {
        /* Excel-like calendar grid styles */
        .excel-calendar {
            display: table !important;
            width: 100% !important;
            border-collapse: collapse !important;
            table-layout: fixed !important;
            border: 2px solid #217346 !important; /* Excel green border */
            background: #fff !important;
        }
        .excel-calendar .calendar-row {
            display: table-row !important;
        }
        .excel-calendar .calendar-heading {
            display: table-cell !important;
            font-weight: bold !important;
            background-color: #d9ead3 !important; /* Excel header green */
            color: #215732 !important;
            border: 1px solid #217346 !important;
            text-align: center !important;
            font-size: 10pt !important;
            padding: 6px 0 !important;
        }
        .excel-calendar .calendar-day {
            display: table-cell !important;
            min-width: 80px !important;
            min-height: 70px !important;
            border: 1px solid #b6d7a8 !important;
            vertical-align: top !important;
            background: #fff !important;
            padding: 4px !important;
        }
        .excel-calendar .calendar-date {
            font-weight: bold !important;
            color: #215732 !important;
            text-align: right !important;
            font-size: 10pt !important;
            margin-bottom: 2px !important;
        }
        .excel-calendar .calendar-entries {
            font-size: 8pt !important;
        }
        .excel-calendar .audit-entry {
            margin: 2px 0 !important;
            padding: 2px 4px !important;
            background-color: #e2f0d9 !important;
            border-left: 2px solid #217346 !important;
        }
        .excel-calendar .today {
            background-color: #fff2cc !important;
        }
        /* Remove image/logo at top (if any) */
        .company-header img, .company-logo { display: none !important; }
        /* Forcible page break between each machine */
        .machine-section {
            page-break-after: always !important;
            page-break-inside: avoid !important;
            display: block !important;
            width: 100% !important;
            margin-bottom: 1.5in !important; /* Space for the certification */
            position: relative !important;
            min-height: 90vh !important;
        }
        .machine-section:last-child {
            page-break-after: auto !important;
        }
        /* Certification footer at bottom of each page */
        .certification-footer {
            position: absolute !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            font-size: 8pt !important;
            text-align: center !important;
            border-top: 1px solid #217346 !important;
            padding: 10px 0 !important;
            font-style: italic !important;
            color: #215732 !important;
        }
        @page {
            size: landscape !important;
            margin: 0.4in !important;
            margin-bottom: 0.6in !important;
        }
    }
</style>
{% endblock %}