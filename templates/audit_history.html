{% extends "base.html" %}

{% block title %}Audit History - Maintenance Tracker{% endblock %}

{% block header_title %}Audit History{% endblock %}

{% block content %}
<!-- Flashed messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container-fluid">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not (current_user.is_admin or (current_user.is_authenticated and current_user.role and (
    (hasattr(current_user.role, 'name') and 'audits.access' in (current_user.role.permissions or '')) or
    (not hasattr(current_user.role, 'name') and Role.query.filter_by(name=current_user.role).first() and 'audits.access' in (Role.query.filter_by(name=current_user.role).first().permissions or ''))
))) %}
  <div class="alert alert-warning text-center my-4" role="alert">
      <h4 class="alert-heading">Audits Feature Not Enabled</h4>
      <p>This feature is not available in your current plan. If you would like access to the Audits module, please contact <a href="mailto:sales@accuratemachinerepair.com">sales@accuratemachinerepair.com</a> for more information.</p>
  </div>
{% else %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">Audit History</h2>
                <div class="d-print-none">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4 d-print-none">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% if show_site_dropdown %}
                        <div class="col-md-3">
                            <label for="site_id" class="form-label">Site</label>
                            <select class="form-select" id="site_id" name="site_id" onchange="updateMachines(this.value)">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <!-- Hidden site_id field when only one site is available -->
                        <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
                        {% endif %}
                        
                        <div class="col-md-3">
                            <label for="machine_id" class="form-label">Machine</label>
                            <select class="form-select" id="machine_id" name="machine_id">
                                <option value="">All Machines</option>
                                {% for machine in available_machines %}
                                <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %} d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Professional Print View (only visible when printing) -->
            <div class="d-none d-print-block">
                <!-- Company Header -->
                <div class="print-header">
                    <div class="company-header">
                        <div class="logo-section">
                            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Company Logo" class="company-logo">
                        </div>
                        <div class="company-info">
                            <h1>Accurate Machine Repair Services</h1>
                            <p>Maintenance Tracking System</p>
                        </div>
                    </div>
                    
                    <!-- Report Title -->
                    <div class="report-title">
                        <h2>AUDIT HISTORY REPORT</h2>
                        <div class="report-id">Report #: AUD-{{ today.strftime('%Y%m%d') }}-{{ '%04d' % range(1, 10000)|random }}</div>
                    </div>
                    
                    <!-- Report Information -->
                    <div class="report-meta">
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Report Period:</th>
                                    <td>{{ start_date.strftime('%B %d, %Y') }} to {{ end_date.strftime('%B %d, %Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Site:</th>
                                    <td>
                                        {% if selected_site %}
                                            {{ sites|selectattr('id', 'eq', selected_site)|map(attribute='name')|list|first }}
                                        {% else %}
                                            All Sites
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if selected_machine %}
                                <tr>
                                    <th>Machine:</th>
                                    <td>{{ available_machines|selectattr('id', 'eq', selected_machine)|map(attribute='name')|list|first }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Generated On:</th>
                                    <td>{{ today.strftime('%B %d, %Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>{{ current_user.full_name or current_user.username }}</td>
                                </tr>
                                <tr>
                                    <th>Document Type:</th>
                                    <td>Official Audit Record</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="executive-summary">
                    <h3>EXECUTIVE SUMMARY</h3>
                    <p>This report documents completed audit tasks within the specified date range. The data presented represents official records of maintenance audits conducted in accordance with operational regulations and internal compliance standards.</p>
                    
                    <div class="summary-metrics">
                        <div class="metric-box">
                            <span class="metric-value">{{ completions|length }}</span>
                            <span class="metric-label">Total Audits</span>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">{{ sorted_dates|length }}</span>
                            <span class="metric-label">Days with Activity</span>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">{{ completions|map(attribute='completed_by')|list|unique|length }}</span>
                            <span class="metric-label">Staff Members</span>
                        </div>
                    </div>
                </div>

                <!-- Report Content -->
                {% if sorted_dates %}
                <div class="report-content">
                    <h3>DETAILED AUDIT RECORDS</h3>
                    
                    {% for date_str in sorted_dates %}
                    <div class="audit-date-section">
                        <h4>{{ date_str|datetime('Y-m-d', '%B %d, %Y') }}</h4>
                        <table class="audit-table">
                            <thead>
                                <tr>
                                    <th>Task ID</th>
                                    <th>Task Name</th>
                                    <th>Machine</th>
                                    <th>Site</th>
                                    <th>Completed By</th>
                                    <th>Time</th>
                                    <th>Frequency</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for completion in grouped_completions[date_str] %}
                                <tr>
                                    <td class="task-id">AT-{{ completion.audit_task_id }}</td>
                                    <td>
                                        {% if audit_tasks.get(completion.audit_task_id) %}
                                            {{ audit_tasks.get(completion.audit_task_id).name }}
                                        {% else %}
                                            Unknown Task
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if machines.get(completion.machine_id) %}
                                            {{ machines.get(completion.machine_id).name }}
                                        {% else %}
                                            Unknown Machine
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if audit_tasks.get(completion.audit_task_id) %}
                                            {% set task = audit_tasks.get(completion.audit_task_id) %}
                                            {% for site in sites if site.id == task.site_id %}
                                                {{ site.name }}
                                            {% endfor %}
                                        {% else %}
                                            Unknown Site
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if users.get(completion.completed_by) %}
                                            {{ users.get(completion.completed_by).full_name or users.get(completion.completed_by).username }}
                                        {% else %}
                                            Unknown User
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if completion.completed_at %}
                                            {{ completion.completed_at.strftime('%H:%M') }}
                                        {% else %}
                                            --
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if audit_tasks.get(completion.audit_task_id) %}
                                            {% if audit_tasks.get(completion.audit_task_id).interval == 'custom' %}
                                                Custom ({{ audit_tasks.get(completion.audit_task_id).custom_interval_days }} days)
                                            {% else %}
                                                {{ audit_tasks.get(completion.audit_task_id).interval|capitalize }}
                                            {% endif %}
                                        {% else %}
                                            Unknown
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data">
                    <h3>NO AUDIT DATA AVAILABLE</h3>
                    <p>No audit history found for the selected date range
                    {% if selected_site %} and site{% endif %}
                    {% if selected_machine %} and machine{% endif %}.</p>
                </div>
                {% endif %}
                
                <!-- Certification Footer -->
                <div class="certification">
                    <h3>CERTIFICATION</h3>
                    <p>This report accurately reflects the audit activities recorded in the Maintenance Tracking System. The information contained herein has been generated automatically and constitutes an official record of maintenance compliance activities.</p>
                    
                    <div class="signatures">
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>System Administrator</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>Compliance Officer</p>
                        </div>
                    </div>
                    
                    <div class="document-footer">
                        <p>Accurate Machine Repair Services &bull; Maintenance Tracking System</p>
                        <p>CONFIDENTIAL - FOR INTERNAL USE ONLY</p>
                        <p>Generated on {{ today.strftime('%Y-%m-%d %H:%M') }} by {{ current_user.username }}</p>
                        <div class="page-number">Page <span class="page"></span> of <span class="pages"></span></div>
                    </div>
                </div>
            </div>

            <!-- Screen View Content (hidden when printing) -->
            <div class="d-print-none">
                <!-- Results -->
                {% if sorted_dates %}
                    {% for date_str in sorted_dates %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h3 class="h5 mb-0">{{ date_str }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Task</th>
                                            <th>Machine</th>
                                            <th>Completed By</th>
                                            <th>Time</th>
                                            <th>Site</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for completion in grouped_completions[date_str] %}
                                            <tr>
                                                <td>
                                                    {% if audit_tasks.get(completion.audit_task_id) %}
                                                        {{ audit_tasks.get(completion.audit_task_id).name }}
                                                        <span class="badge bg-secondary ms-1">
                                                            {% if audit_tasks.get(completion.audit_task_id).interval == 'custom' %}
                                                                Custom ({{ audit_tasks.get(completion.audit_task_id).custom_interval_days }} days)
                                                            {% else %}
                                                                {{ audit_tasks.get(completion.audit_task_id).interval|capitalize }}
                                                            {% endif %}
                                                        </span>
                                                    {% else %}
                                                        Unknown Task
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if machines.get(completion.machine_id) %}
                                                        {{ machines.get(completion.machine_id).name }}
                                                    {% else %}
                                                        Unknown Machine
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if users.get(completion.completed_by) %}
                                                        {{ users.get(completion.completed_by).full_name or users.get(completion.completed_by).username }}
                                                    {% else %}
                                                        Unknown User
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if completion.completed_at %}
                                                        {{ completion.completed_at.strftime('%H:%M') }}
                                                    {% else %}
                                                        --
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if audit_tasks.get(completion.audit_task_id) %}
                                                        {% set task = audit_tasks.get(completion.audit_task_id) %}
                                                        {% for site in sites if site.id == task.site_id %}
                                                            {{ site.name }}
                                                        {% endfor %}
                                                    {% else %}
                                                        Unknown Site
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        No audit history found for the selected date range
                        {% if selected_site %} and site{% endif %}
                        {% if selected_machine %} and machine{% endif %}.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store machine data in a JavaScript variable
    // This completely separates Jinja template logic from JavaScript
    var machineData = [
        {% for machine in available_machines %}
            {% if machine.site_id is defined %}
            {
                id: "{{ machine.id }}",
                name: "{{ machine.name|replace('"', '\\"')|replace("'", "\\'") }}",
                siteId: "{{ machine.site_id }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];
    
    // Store the selected values in JavaScript variables
    var selectedSiteId = "{{ sites[0].id if sites and not show_site_dropdown else selected_site|default('') }}";
    var selectedMachineId = "{{ selected_machine|default('') }}";
    
    // Function to update available machines when site selection changes
    function updateMachines(siteId) {
        // Get the machine dropdown
        const machineDropdown = document.getElementById('machine_id');
        
        // Clear current options except for the "All Machines" option
        while (machineDropdown.options.length > 1) {
            machineDropdown.remove(1);
        }
        
        // If no site selected, we're done (keep just "All Machines" option)
        if (!siteId) {
            return;
        }
        
        // Add machines for the selected site
        machineData.forEach(function(machine) {
            if (machine.siteId === siteId) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            }
        });
        
        // If we have a previously selected machine, try to restore it
        if (selectedMachineId) {
            for (let i = 0; i < machineDropdown.options.length; i++) {
                if (machineDropdown.options[i].value === selectedMachineId) {
                    machineDropdown.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Initialize the machine dropdown when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const siteDropdown = document.getElementById('site_id');
        if (siteDropdown && siteDropdown.value) {
            updateMachines(siteDropdown.value);
        }
    });
</script>
{% endblock %}

{% block styles %}
<style>
    /* Regular styles remain unchanged */
    
    /* Professional Print Styling */
    @media print {
        @page {
            size: letter portrait;
            margin: 0.5in;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 11pt;
            line-height: 1.4;
            color: #000;
            background: #fff;
            margin: 0;
            padding: 0;
        }
        
        /* Hide screen-only elements */
        .d-print-none {
            display: none !important;
        }
        
        /* Show print-only elements */
        .d-none.d-print-block {
            display: block !important;
        }
        
        /* Company Header */
        .print-header {
            margin-bottom: 20px;
        }
        
        .company-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        
        .company-logo {
            height: 60px;
            width: auto;
        }
        
        .company-info {
            text-align: right;
        }
        
        .company-info h1 {
            font-size: 18pt;
            font-weight: bold;
            margin: 0;
            color: #2c3e50;
        }
        
        .company-info p {
            font-size: 12pt;
            margin: 0;
            color: #7f8c8d;
        }
        
        /* Report Title */
        .report-title {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        .report-title h2 {
            font-size: 16pt;
            font-weight: bold;
            text-transform: uppercase;
            margin: 0;
            padding: 10px 0;
            color: #2c3e50;
            border-bottom: 1px solid #bdc3c7;
            border-top: 1px solid #bdc3c7;
        }
        
        .report-id {
            position: absolute;
            top: 0;
            right: 0;
            font-size: 10pt;
            color: #7f8c8d;
        }
        
        /* Report Meta Information */
        .report-meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            font-size: 10pt;
        }
        
        .report-section {
            width: 48%;
        }
        
        .meta-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .meta-table th {
            text-align: left;
            padding: 5px;
            font-weight: bold;
            width: 35%;
            vertical-align: top;
        }
        
        .meta-table td {
            padding: 5px;
            border-bottom: 1px dotted #ddd;
        }
        
        /* Executive Summary */
        .executive-summary {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .executive-summary h3 {
            font-size: 14pt;
            margin: 0 0 10px 0;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .executive-summary p {
            margin: 0 0 15px 0;
            font-size: 10pt;
        }
        
        .summary-metrics {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
        }
        
        .metric-box {
            text-align: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 30%;
        }
        
        .metric-value {
            display: block;
            font-size: 20pt;
            font-weight: bold;
            color: #16a085;
        }
        
        .metric-label {
            display: block;
            font-size: 9pt;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        /* Report Content */
        .report-content {
            margin-bottom: 30px;
        }
        
        .report-content h3 {
            font-size: 14pt;
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }
        
        .audit-date-section {
            margin-bottom: 30px;
            page-break-inside: avoid;
        }
        
        .audit-date-section h4 {
            font-size: 12pt;
            margin: 0 0 10px 0;
            padding: 5px 10px;
            background-color: #ecf0f1;
            border-left: 4px solid #3498db;
        }
        
        .audit-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 9pt;
            margin-bottom: 15px;
        }
        
        .audit-table th {
            background-color: #34495e;
            color: #fff;
            font-weight: bold;
            text-align: left;
            padding: 8px;
            border: 1px solid #2c3e50;
        }
        
        .audit-table td {
            padding: 6px 8px;
            border: 1px solid #bdc3c7;
            vertical-align: top;
        }
        
        .audit-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .task-id {
            font-family: "Courier New", monospace;
            font-weight: bold;
            color: #7f8c8d;
        }
        
        /* No Data Message */
        .no-data {
            text-align: center;
            padding: 30px;
            margin: 20px 0;
            border: 1px dashed #bdc3c7;
            background-color: #f8f9fa;
        }
        
        .no-data h3 {
            font-size: 14pt;
            color: #e74c3c;
            margin: 0 0 10px 0;
        }
        
        .no-data p {
            color: #7f8c8d;
            margin: 0;
        }
        
        /* Certification Footer */
        .certification {
            margin-top: 40px;
            border-top: 1px solid #bdc3c7;
            padding-top: 20px;
        }
        
        .certification h3 {
            font-size: 12pt;
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        
        .certification p {
            font-size: 9pt;
            margin: 0 0 20px 0;
        }
        
        .signatures {
            display: flex;
            justify-content: space-around;
            margin: 30px 0;
        }
        
        .signature-block {
            width: 40%;
            text-align: center;
        }
        
        .signature-line {
            border-bottom: 1px solid #000;
            height: 40px;
            margin-bottom: 5px;
        }
        
        .signature-block p {
            margin: 0;
            font-size: 9pt;
        }
        
        .document-footer {
            margin-top: 40px;
            text-align: center;
            font-size: 8pt;
            color: #7f8c8d;
            border-top: 1px solid #bdc3c7;
            padding-top: 10px;
        }
        
        .document-footer p {
            margin: 3px 0;
        }
        
        .page-number {
            margin-top: 10px;
        }
        
        .page-number::after {
            content: counter(page);
        }
        
        .pages::after {
            content: counter(pages);
        }
        
        /* Fix for date formatting */
        .formatted-date::before {
            content: attr(data-date);
        }
    }
</style>

<script>
    // Script to handle page numbering when printing
    window.onbeforeprint = function() {
        // Create page counter style elements - will only run in print preview
        var style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `
            @page {
                counter-increment: page;
            }
            body {
                counter-reset: pages ${document.querySelectorAll('.audit-date-section').length + 1};
            }
            .page::after {
                content: counter(page);
            }
            .pages::after {
                content: counter(pages);
            }
        `;
        document.head.appendChild(style);
    };
</script>
{% endblock %}