{% extends "base.html" %}

{% block title %}Audit History - Maintenance Tracker{% endblock %}

{% block header_title %}Audit History{% endblock %}

{% block content %}
<!-- Flashed messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container-fluid">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not (current_user.is_admin or (current_user.is_authenticated and current_user.role and (
    (hasattr(current_user.role, 'name') and 'audits.access' in (current_user.role.permissions or '')) or
    (not hasattr(current_user.role, 'name') and Role.query.filter_by(name=current_user.role).first() and 'audits.access' in (Role.query.filter_by(name=current_user.role).first().permissions or ''))
))) %}
  <div class="alert alert-warning text-center my-4" role="alert">
      <h4 class="alert-heading">Audits Feature Not Enabled</h4>
      <p>This feature is not available in your current plan. If you would like access to the Audits module, please contact <a href="mailto:sales@accuratemachinerepair.com">sales@accuratemachinerepair.com</a> for more information.</p>
  </div>
{% else %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">Audit History</h2>
                <div class="d-print-none">
                    <button class="btn btn-primary me-2" id="downloadPdfButton">
                        <i class="fas fa-file-pdf me-1"></i> Download PDF
                    </button>
                    <button class="btn btn-primary" id="printButton">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4 d-print-none">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% if show_site_dropdown %}
                        <div class="col-md-3">
                            <label for="site_id" class="form-label">Site</label>
                            <select class="form-select" id="site_id" name="site_id" onchange="updateMachines(this.value)">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <!-- Hidden site_id field when only one site is available -->
                        <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
                        {% endif %}
                        
                        <div class="col-md-3">
                            <label for="machine_id" class="form-label">Machine</label>
                            <select class="form-select" id="machine_id" name="machine_id">
                                <option value="">All Machines</option>
                                {% for machine in available_machines %}
                                <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %} d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Print-only view -->
            <div class="d-none d-print-block" id="printView">
                <div class="print-header">
                    <div class="company-info">
                        <h1>AMRS Preventative Maintenance</h1>
                        <p>Machine Audit History Report</p>
                    </div>
                    <div class="report-title">
                        <h2>Audit History Report</h2>
                        <span class="report-id">Generated on {{ today.strftime('%Y-%m-%d') }}</span>
                    </div>
                    <div class="report-meta">
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Date Range:</th>
                                    <td>{{ start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>{{ current_user.full_name }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Total Machines:</th>
                                    <td>{{ display_machines|length }}</td>
                                </tr>
                                <tr>
                                    <th>Total Records:</th>
                                    <td>{{ completions|length }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                {% for machine in display_machines %}
                <div class="machine-section">
                    <div class="machine-title">
                        {{ machine.name }} {% if machine.machine_id %}({{ machine.machine_id }}){% endif %}
                    </div>
                    {% if machine.id in machine_data %}
                        {% set date_range = get_date_range(start_date, end_date) %}
                        
                        <!-- Calendar with Legend Layout -->
                        <div class="print-calendar-with-legend">
                            <!-- Begin Calendar View -->
                            <div class="calendar-table-container">
                                <table class="calendar-table excel-calendar">
                                    {% set current_month = None %}
                                    {% for week in get_calendar_weeks(start_date, end_date) %}
                                        {% set first_date_in_week = week|select('defined')|first %}
                                        {% if first_date_in_week and (current_month != first_date_in_week.month) %}
                                            {% set current_month = first_date_in_week.month %}
                                            <tr>
                                                <td colspan="7" class="month-header">
                                                    {{ first_date_in_week.strftime('%B %Y') }}
                                                </td>
                                            </tr>
                                            <tr>
                                                <th class="calendar-heading">Sunday</th>
                                                <th class="calendar-heading">Monday</th>
                                                <th class="calendar-heading">Tuesday</th>
                                                <th class="calendar-heading">Wednesday</th>
                                                <th class="calendar-heading">Thursday</th>
                                                <th class="calendar-heading">Friday</th>
                                                <th class="calendar-heading">Saturday</th>
                                            </tr>
                                        {% endif %}
                                        <tr>
                                            {% for date in week %}
                                                <td class="calendar-day{% if date and date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %} today{% endif %}">
                                                    {% if date %}
                                                        <div class="calendar-date">{{ date.day }}</div>
                                                        <div class="calendar-entries">
                                                            {% set date_str = date.strftime('%Y-%m-%d') %}
                                                            {% if machine.id in machine_data and date_str in machine_data[machine.id] %}
                                                                {% for audit in machine_data[machine.id][date_str] %}
                                                                    <div class="audit-entry"
                                                                        {% if audit.audit_task_id in audit_tasks %}
                                                                        data-task-type="{{ audit_tasks[audit.audit_task_id].category if audit_tasks[audit.audit_task_id].category else 'general' }}"
                                                                        {% endif %}>
                                                                        <div class="audit-time">{{ audit.completed_at.strftime('%H:%M') if audit.completed_at else '' }}</div>
                                                                        <div class="audit-task">{{ audit_tasks[audit.audit_task_id].name if audit.audit_task_id in audit_tasks else 'Unknown Task' }}</div>
                                                                        <div class="audit-user">{{ users[audit.completed_by].full_name if audit.completed_by in users else 'Unknown User' }}</div>
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                            {% endfor %}
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                            
                            <!-- Print Legend -->
                            <div class="print-calendar-legend">
                                <h6 class="legend-title">Legend</h6>
                                <div class="legend-items">
                                    {% set task_types = {} %}
                                    {% for task_id, task in audit_tasks.items() %}
                                        {% if task.category %}
                                            {% if task.category not in task_types %}
                                                {% if task_types.update({task.category: task.name}) %}{% endif %}
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Add general category if we don't have custom categories -->
                                    {% if not task_types %}
                                        <div class="legend-item">
                                            <span class="legend-color" style="background-color: #e2f0d9;"></span>
                                            <span class="legend-text">Maintenance Task</span>
                                        </div>
                                    {% else %}
                                        {% for category, example_name in task_types.items() %}
                                        <div class="legend-item">
                                            <span class="legend-color category-{{ category|lower|replace(' ', '-') }}"></span>
                                            <span class="legend-text">{{ category }}</span>
                                        </div>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    <div class="legend-item">
                                        <span class="legend-color today-indicator"></span>
                                        <span class="legend-text">Today ({{ today.strftime('%Y-%m-%d') }})</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="no-data">
                            No audit records found for this machine in the selected date range.
                        </div>
                    {% endif %}
                    <!-- Certification Footer -->
                    <div class="certification-footer">
                        This document certifies that all recorded maintenance tasks have been performed according to 
                        AMRS Preventative Maintenance standards and protocols. Report ID: {{ '%Y%m%d%H%M%S'|format_datetime }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Screen-only regular view -->
            <div class="d-print-none">
                {% if display_machines|length == 0 %}
                <div class="alert alert-info">
                    No machine audit data found for the selected date range and filters.
                </div>
                {% endif %}
                
                {% for machine in display_machines %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ machine.name }} {% if machine.machine_id %}({{ machine.machine_id }}){% endif %}</h5>
                    </div>
                    <div class="card-body">
                        {% if machine.id in machine_data %}
                            {% set date_range = get_date_range(start_date, end_date) %}
                            <!-- Calendar with Legend Layout -->
                            <div class="calendar-with-legend">
                                <!-- Begin Calendar View using TABLE inside a container div -->
                                <div class="calendar-table-container">
                                    <table class="calendar-table excel-style-table">
                                        {% set current_month = None %}
                                        {% for week in get_calendar_weeks(start_date, end_date) %}
                                            {% set first_date_in_week = week|select('defined')|first %}
                                            {% if first_date_in_week and (current_month != first_date_in_week.month) %}
                                                {% set current_month = first_date_in_week.month %}
                                                <tr>
                                                    <td colspan="7" class="month-header">
                                                        {{ first_date_in_week.strftime('%B %Y') }}
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>Sunday</th>
                                                    <th>Monday</th>
                                                    <th>Tuesday</th>
                                                    <th>Wednesday</th>
                                                    <th>Thursday</th>
                                                    <th>Friday</th>
                                                    <th>Saturday</th>
                                                </tr>
                                            {% endif %}
                                            <tr>
                                                {% for date in week %}
                                                <td class="calendar-day {% if not date %}empty-day{% endif %} {% if date and date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %}today{% endif %}">
                                                    {% if date %}
                                                        <div class="calendar-date">{{ date.day }}</div>
                                                        <div class="calendar-entries">
                                                            {% set date_str = date.strftime('%Y-%m-%d') %}
                                                            {% if machine.id in machine_data and date_str in machine_data[machine.id] %}
                                                                {% for audit in machine_data[machine.id][date_str] %}
                                                                    <div class="audit-entry" 
                                                                        {% if audit.audit_task_id in audit_tasks %}
                                                                        data-task-type="{{ audit_tasks[audit.audit_task_id].category if audit_tasks[audit.audit_task_id].category else 'general' }}"
                                                                        {% endif %}>
                                                                        <div class="audit-time">{{ audit.completed_at.strftime('%H:%M') if audit.completed_at else '' }}</div>
                                                                        <div class="audit-task">{{ audit_tasks[audit.audit_task_id].name if audit.audit_task_id in audit_tasks else 'Unknown Task' }}</div>
                                                                        <div class="audit-user">{{ users[audit.completed_by].full_name if audit.completed_by in users else 'Unknown User' }}</div>
                                                                    </div>
                                                                {% endfor %}
                                                            {% endif %}
                                                        </div>
                                                    {% endif %}
                                                </td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </table>
                                </div>
                                
                                <!-- Legend Section -->
                                <div class="calendar-legend">
                                    <h6 class="legend-title">Legend</h6>
                                    <div class="legend-items">
                                        {% set task_types = {} %}
                                        {% for task_id, task in audit_tasks.items() %}
                                            {% if task.category %}
                                                {% if task.category not in task_types %}
                                                    {% if task_types.update({task.category: task.name}) %}{% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Add general category if we don't have custom categories -->
                                        {% if not task_types %}
                                            <div class="legend-item">
                                                <span class="legend-color" style="background-color: #e2f0d9;"></span>
                                                <span class="legend-text">Maintenance Task</span>
                                            </div>
                                        {% else %}
                                            {% for category, example_name in task_types.items() %}
                                            <div class="legend-item">
                                                <span class="legend-color category-{{ category|lower|replace(' ', '-') }}"></span>
                                                <span class="legend-text">{{ category }}</span>
                                            </div>
                                            {% endfor %}
                                        {% endif %}
                                        
                                        <div class="legend-item">
                                            <span class="legend-color today-indicator"></span>
                                            <span class="legend-text">Today ({{ today.strftime('%Y-%m-%d') }})</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="no-data">
                                No audit records found for this machine in the selected date range.
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store machine data in a JavaScript variable
    // This completely separates Jinja template logic from JavaScript
    var machineData = [
        {% for machine in available_machines %}
            {% if machine.site_id is defined %}
            {
                id: "{{ machine.id }}",
                name: "{{ machine.name|replace('"', '\\"')|replace("'", "\\'") }}",
                siteId: "{{ machine.site_id }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];
    
    // Store the selected values in JavaScript variables
    var selectedSiteId = "{{ selected_site|default('') }}";
    var selectedMachineId = "{{ selected_machine|default('') }}";
    
    // Function to update available machines when site selection changes
    function updateMachines(siteId) {
        // Get the machine dropdown
        const machineDropdown = document.getElementById('machine_id');
        
        // Clear current options except for the "All Machines" option
        while (machineDropdown.options.length > 1) {
            machineDropdown.remove(1);
        }
        
        // If no site selected, show all machines
        if (!siteId) {
            machineData.forEach(function(machine) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            });
            return;
        }
        
        // Add machines for the selected site
        machineData.forEach(function(machine) {
            if (machine.siteId === siteId) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            }
        });
        
        // If we have a previously selected machine, try to restore it
        if (selectedMachineId) {
            for (let i = 0; i < machineDropdown.options.length; i++) {
                if (machineDropdown.options[i].value === selectedMachineId) {
                    machineDropdown.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Function to download the PDF report
    function downloadPDF() {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('site_id') || '';
        const machineId = urlParams.get('machine_id') || '';
        const startDate = urlParams.get('start_date') || '';
        const endDate = urlParams.get('end_date') || '';
        
        // Construct the PDF URL with the same parameters
        let pdfUrl = '/audit_history/pdf?';
        if (siteId) pdfUrl += `site_id=${siteId}&`;
        if (machineId) pdfUrl += `machine_id=${machineId}&`;
        if (startDate) pdfUrl += `start_date=${startDate}&`;
        if (endDate) pdfUrl += `end_date=${endDate}`;
        
        // Open in a new window/tab
        window.open(pdfUrl, '_blank');
    }
    
    // Initialize the machine dropdown when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const siteDropdown = document.getElementById('site_id');
        
        // Always initialize the machine dropdown, even with blank site
        updateMachines(siteDropdown ? siteDropdown.value : '');
        
        // Set up print button with custom handler
        document.getElementById('printButton').addEventListener('click', function() {
            window.print();
        });
        
        // Set up download PDF button
        document.getElementById('downloadPdfButton').addEventListener('click', downloadPDF);
    });

    // Fix for blank screen after print preview
    window.addEventListener('afterprint', function() {
        // No need to do anything special, the browser will maintain the state
        // The problem was the visibility:hidden in the previous CSS
    });
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Reset calendar view completely with basic, reliable table formatting */
    .calendar-table {
        table-layout: fixed !important;
        width: 100% !important;
        border-collapse: collapse !important;
        border: 3px solid #217346 !important;
        margin-bottom: 20px !important;
    }
    
    /* Month header styling */
    .month-header {
        background-color: #217346 !important; 
        color: white !important;
        font-weight: bold !important;
        text-align: center !important;
        padding: 8px !important;
        font-size: 1.1rem !important;
        border-bottom: 2px solid #1a5c38 !important;
        text-transform: uppercase !important;
        letter-spacing: 1px !important;
        position: relative !important;
    }
    
    /* Day of week header styling */
    .calendar-table thead th {
        background-color: #d9ead3 !important;
        color: #215732 !important;
        font-weight: bold !important;
        padding: 8px 5px !important;
        border: 2px solid #b6d7a8 !important;
        text-align: center !important;
        width: 14.2857% !important; /* Equal 7 day columns */
    }
    
    /* Force columns to be equal width */
    .calendar-table td {
        width: 14.2857% !important;
        display: table-cell !important;
        border: 2px solid #b6d7a8 !important; 
        vertical-align: top !important;
        padding: 5px !important;
        position: relative !important;
        height: 100px !important; /* Fixed height for consistency */
    }
    
    /* Apply very specific styling to ensure proper display */
    .calendar-table tr {
        display: table-row !important;
    }

    /* Calendar with legend layout */
    .calendar-with-legend {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 20px !important;
        align-items: flex-start !important;
    }
    
    .calendar-table-container {
        width: 80% !important;
        flex-grow: 1 !important;
        overflow-x: auto !important; /* For small screens */
    }
    
    .calendar-legend {
        width: 20% !important;
        max-width: 220px !important;
        flex-shrink: 0 !important;
        padding: 12px !important;
        border: 1px solid #217346 !important;
        background-color: #f8f9fa !important;
        border-radius: 5px !important;
        position: sticky !important;
        top: 10px !important;
    }
    
    /* Date number styling */
    .calendar-date {
        font-weight: bold !important;
        text-align: right !important;
        margin-bottom: 5px !important;
        font-size: 0.9rem !important;
        color: #215732 !important;
        border-bottom: 1px solid #b6d7a8 !important;
        padding-bottom: 2px !important;
    }
    
    /* Empty date cell styling */
    .calendar-day.empty-day {
        background-color: #f8f9fa !important;
        border-color: #e9ecef !important;
    }
    
    .calendar-entries {
        font-size: 0.8rem !important;
        text-align: left !important;
        max-height: 70px !important;
        overflow-y: auto !important;
    }
    
    /* Simple colored checkmark system for the legend */
    .status-indicator {
        display: inline-block !important;
        width: 12px !important;
        height: 12px !important;
        margin-right: 5px !important;
        border-radius: 50% !important;
    }
    
    /* Legend styling */
    .legend-title {
        font-size: 1rem !important;
        font-weight: bold !important;
        margin-bottom: 12px !important;
        color: #215732 !important;
        border-bottom: 1px solid #217346 !important;
        padding-bottom: 5px !important;
    }
    
    .legend-items {
        display: flex !important;
        flex-direction: column !important;
        gap: 8px !important;
    }
    
    .legend-item {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
    }
    
    .legend-color {
        width: 16px !important;
        height: 16px !important;
        border-radius: 3px !important;
        display: inline-block !important;
        border: 1px solid rgba(0,0,0,0.2) !important;
    }
    
    /* Color coding for tasks */
    .legend-color, [data-task-type="general"] {
        background-color: #e2f0d9 !important;
        border-left-color: #217346 !important;
    }
    
    .legend-color.category-preventative, [data-task-type="preventative"] {
        background-color: #c6e0b4 !important;
        border-left-color: #548235 !important;
    }
    
    .legend-color.category-scheduled, [data-task-type="scheduled"] {
        background-color: #b4c7e7 !important;
        border-left-color: #2f5597 !important;
    }
    
    .legend-color.category-emergency, [data-task-type="emergency"] {
        background-color: #f8cbad !important;
        border-left-color: #c65911 !important;
    }
    
    .legend-color.category-inspection, [data-task-type="inspection"] {
        background-color: #fff2cc !important;
        border-left-color: #bf9000 !important;
    }
    
    .legend-color.category-repair, [data-task-type="repair"] {
        background-color: #d9d9d9 !important;
        border-left-color: #7f7f7f !important;
    }
    
    .legend-color.today-indicator, .today {
        background-color: #ffeb9c !important;
        border: 1px solid #9c6500 !important;
    }
    
    .legend-text {
        font-size: 0.85rem !important;
        color: #333 !important;
    }
    
    .audit-entry {
        margin-bottom: 5px !important;
        padding: 4px !important;
        background-color: #e2f0d9 !important;
        border-radius: 3px !important;
        border-left: 3px solid #217346 !important;
    }
    
    .audit-time {
        font-size: 0.7rem !important;
        color: #595959 !important;
        font-weight: bold !important;
    }
    
    .audit-task {
        font-weight: 600 !important;
        color: #215732 !important;
    }
    
    .audit-user {
        font-size: 0.7rem !important;
        font-style: italic !important;
        color: #595959 !important;
    }
    
    .today {
        background-color: #ffeb9c !important;
        box-shadow: inset 0 0 5px rgba(156, 101, 0, 0.3) !important;
    }
    
    /* Responsive behavior for small screens */
    @media (max-width: 992px) {
        .calendar-with-legend {
            flex-direction: column !important;
        }
        
        .calendar-table-container,
        .calendar-legend {
            width: 100% !important;
            max-width: 100% !important;
        }
    }
    
    /* Print styles */
    @media print {
        .print-calendar-with-legend {
            display: flex !important;
            flex-direction: row !important;
            gap: 20px !important;
        }
        
        .calendar-table-container {
            width: 80% !important;
            flex-grow: 1 !important;
        }
        
        .print-calendar-legend {
            width: 20% !important;
            max-width: 200px !important;
            flex-shrink: 0 !important;
        }
        
        .excel-calendar {
            table-layout: fixed !important;
            width: 100% !important;
            border-collapse: collapse !important;
            border: 2px solid #217346 !important;
        }
        
        .excel-calendar th, 
        .excel-calendar td {
            width: 14.2857% !important;
            border: 2px solid #b6d7a8 !important;
        }
        
        .month-header {
            page-break-inside: avoid !important;
        }
    }
</style>
{% endblock %}