{% extends "base.html" %}

{% block title %}Audit History - Maintenance Tracker{% endblock %}

{% block header_title %}Audit History{% endblock %}

{% block content %}
<!-- Flashed messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container-fluid">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not (current_user.is_admin or (current_user.is_authenticated and current_user.role and (
    (hasattr(current_user.role, 'name') and 'audits.access' in (current_user.role.permissions or '')) or
    (not hasattr(current_user.role, 'name') and Role.query.filter_by(name=current_user.role).first() and 'audits.access' in (Role.query.filter_by(name=current_user.role).first().permissions or ''))
))) %}
  <div class="alert alert-warning text-center my-4" role="alert">
      <h4 class="alert-heading">Audits Feature Not Enabled</h4>
      <p>This feature is not available in your current plan. If you would like access to the Audits module, please contact <a href="mailto:sales@accuratemachinerepair.com">sales@accuratemachinerepair.com</a> for more information.</p>
  </div>
{% else %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">Audit History</h2>
                <div class="d-print-none">
                    <button class="btn btn-primary me-2" id="downloadPdfButton">
                        <i class="fas fa-file-pdf me-1"></i> Download PDF
                    </button>
                    <button class="btn btn-primary" id="printButton">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4 d-print-none">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% if show_site_dropdown %}
                        <div class="col-md-3">
                            <label for="site_id" class="form-label">Site</label>
                            <select class="form-select" id="site_id" name="site_id" onchange="updateMachines(this.value)">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <!-- Hidden site_id field when only one site is available -->
                        <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
                        {% endif %}
                        
                        <div class="col-md-3">
                            <label for="machine_id" class="form-label">Machine</label>
                            <select class="form-select" id="machine_id" name="machine_id">
                                <option value="">All Machines</option>
                                {% for machine in available_machines %}
                                <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %} d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Print-only view -->
            <div class="d-none d-print-block" id="printView">
                <div class="print-header">
                    <div class="company-info">
                        <h1>AMRS Preventative Maintenance</h1>
                        <p>Machine Audit History Report</p>
                    </div>
                    <div class="report-title">
                        <h2>Audit History Report</h2>
                        <span class="report-id">Generated on {{ today.strftime('%Y-%m-%d') }}</span>
                    </div>
                    <div class="report-meta">
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Date Range:</th>
                                    <td>{{ start_date.strftime('%Y-%m-%d') }} to {{ end_date.strftime('%Y-%m-%d') }}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>{{ current_user.full_name }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Total Machines:</th>
                                    <td>{{ display_machines|length }}</td>
                                </tr>
                                <tr>
                                    <th>Total Records:</th>
                                    <td>{{ completions|length }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                {% for machine in display_machines %}
                <div class="machine-section">
                    <div class="machine-title">
                        {{ machine.name }} {% if machine.machine_id %}({{ machine.machine_id }}){% endif %}
                    </div>
                    {% if machine.id in machine_data %}
                        {% set date_range = get_date_range(start_date, end_date) %}
                        <!-- Begin Calendar View -->
                        <div class="calendar-grid excel-calendar">
                            <!-- Calendar Headers (Days of Week) -->
                            <div class="calendar-row">
                                <div class="calendar-heading">Sunday</div>
                                <div class="calendar-heading">Monday</div>
                                <div class="calendar-heading">Tuesday</div>
                                <div class="calendar-heading">Wednesday</div>
                                <div class="calendar-heading">Thursday</div>
                                <div class="calendar-heading">Friday</div>
                                <div class="calendar-heading">Saturday</div>
                            </div>
                            <!-- Calendar Days -->
                            {% for week in get_calendar_weeks(start_date, end_date) %}
                            <div class="calendar-row">
                                {% for date in week %}
                                    <div class="calendar-day{% if date and date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %} today{% endif %}">
                                        {% if date %}
                                            <div class="calendar-date">{{ date.day }}</div>
                                            <div class="calendar-entries">
                                                {% set date_str = date.strftime('%Y-%m-%d') %}
                                                {% if machine.id in machine_data and date_str in machine_data[machine.id] %}
                                                    {% for audit in machine_data[machine.id][date_str] %}
                                                        <div class="audit-entry">
                                                            <div class="audit-time">{{ audit.completed_at.strftime('%H:%M') if audit.completed_at else '' }}</div>
                                                            <div class="audit-task">{{ audit_tasks[audit.audit_task_id].name if audit.audit_task_id in audit_tasks else 'Unknown Task' }}</div>
                                                            <div class="audit-user">{{ users[audit.completed_by].full_name if audit.completed_by in users else 'Unknown User' }}</div>
                                                        </div>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        <!-- End Calendar View -->
                    {% else %}
                        <div class="no-data">
                            No audit records found for this machine in the selected date range.
                        </div>
                    {% endif %}
                    <!-- Certification Footer -->
                    <div class="certification-footer">
                        This document certifies that all recorded maintenance tasks have been performed according to 
                        AMRS Preventative Maintenance standards and protocols. Report ID: {{ '%Y%m%d%H%M%S'|format_datetime }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Screen-only regular view -->
            <div class="d-print-none">
                {% if display_machines|length == 0 %}
                <div class="alert alert-info">
                    No machine audit data found for the selected date range and filters.
                </div>
                {% endif %}
                
                {% for machine in display_machines %}
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">{{ machine.name }} {% if machine.machine_id %}({{ machine.machine_id }}){% endif %}</h5>
                    </div>
                    <div class="card-body">
                        {% if machine.id in machine_data %}
                            {% set date_range = get_date_range(start_date, end_date) %}
                            <!-- Begin Calendar View -->
                            <div class="calendar-grid excel-style-calendar">
                                <!-- Calendar Headers (Days of Week) -->
                                <div class="calendar-row">
                                    <div class="calendar-heading">Sunday</div>
                                    <div class="calendar-heading">Monday</div>
                                    <div class="calendar-heading">Tuesday</div>
                                    <div class="calendar-heading">Wednesday</div>
                                    <div class="calendar-heading">Thursday</div>
                                    <div class="calendar-heading">Friday</div>
                                    <div class="calendar-heading">Saturday</div>
                                </div>
                                <!-- Calendar Days -->
                                {% for week in get_calendar_weeks(start_date, end_date) %}
                                <div class="calendar-row">
                                    {% for date in week %}
                                        <div class="calendar-day{% if date and date.strftime('%Y-%m-%d') == today.strftime('%Y-%m-%d') %} today{% endif %}">
                                            {% if date %}
                                                <div class="calendar-date">{{ date.day }}</div>
                                                <div class="calendar-entries">
                                                    {% set date_str = date.strftime('%Y-%m-%d') %}
                                                    {% if machine.id in machine_data and date_str in machine_data[machine.id] %}
                                                        {% for audit in machine_data[machine.id][date_str] %}
                                                            <div class="audit-entry">
                                                                <div class="audit-time">{{ audit.completed_at.strftime('%H:%M') if audit.completed_at else '' }}</div>
                                                                <div class="audit-task">{{ audit_tasks[audit.audit_task_id].name if audit.audit_task_id in audit_tasks else 'Unknown Task' }}</div>
                                                                <div class="audit-user">{{ users[audit.completed_by].full_name if audit.completed_by in users else 'Unknown User' }}</div>
                                                            </div>
                                                        {% endfor %}
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% endfor %}
                            </div>
                            <!-- End Calendar View -->
                        {% else %}
                            <div class="no-data">
                                No audit records found for this machine in the selected date range.
                            </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store machine data in a JavaScript variable
    // This completely separates Jinja template logic from JavaScript
    var machineData = [
        {% for machine in available_machines %}
            {% if machine.site_id is defined %}
            {
                id: "{{ machine.id }}",
                name: "{{ machine.name|replace('"', '\\"')|replace("'", "\\'") }}",
                siteId: "{{ machine.site_id }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];
    
    // Store the selected values in JavaScript variables
    var selectedSiteId = "{{ selected_site|default('') }}";
    var selectedMachineId = "{{ selected_machine|default('') }}";
    
    // Function to update available machines when site selection changes
    function updateMachines(siteId) {
        // Get the machine dropdown
        const machineDropdown = document.getElementById('machine_id');
        
        // Clear current options except for the "All Machines" option
        while (machineDropdown.options.length > 1) {
            machineDropdown.remove(1);
        }
        
        // If no site selected, show all machines
        if (!siteId) {
            machineData.forEach(function(machine) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            });
            return;
        }
        
        // Add machines for the selected site
        machineData.forEach(function(machine) {
            if (machine.siteId === siteId) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            }
        });
        
        // If we have a previously selected machine, try to restore it
        if (selectedMachineId) {
            for (let i = 0; i < machineDropdown.options.length; i++) {
                if (machineDropdown.options[i].value === selectedMachineId) {
                    machineDropdown.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Function to download the PDF report
    function downloadPDF() {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('site_id') || '';
        const machineId = urlParams.get('machine_id') || '';
        const startDate = urlParams.get('start_date') || '';
        const endDate = urlParams.get('end_date') || '';
        
        // Construct the PDF URL with the same parameters
        let pdfUrl = '/audit_history/pdf?';
        if (siteId) pdfUrl += `site_id=${siteId}&`;
        if (machineId) pdfUrl += `machine_id=${machineId}&`;
        if (startDate) pdfUrl += `start_date=${startDate}&`;
        if (endDate) pdfUrl += `end_date=${endDate}`;
        
        // Open in a new window/tab
        window.open(pdfUrl, '_blank');
    }
    
    // Initialize the machine dropdown when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const siteDropdown = document.getElementById('site_id');
        
        // Always initialize the machine dropdown, even with blank site
        updateMachines(siteDropdown ? siteDropdown.value : '');
        
        // Set up print button with custom handler
        document.getElementById('printButton').addEventListener('click', function() {
            window.print();
        });
        
        // Set up download PDF button
        document.getElementById('downloadPdfButton').addEventListener('click', downloadPDF);
    });

    // Fix for blank screen after print preview
    window.addEventListener('afterprint', function() {
        // No need to do anything special, the browser will maintain the state
        // The problem was the visibility:hidden in the previous CSS
    });
</script>
{% endblock %}

{% block styles %}
{{ super() }}
<style>
    /* Screen styles for calendar */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
    }
    
    /* Excel-style calendar for web view */
    .excel-style-calendar {
        border: 2px solid #217346; /* Excel green border */
    }
    
    .excel-style-calendar .calendar-heading {
        background-color: #d9ead3; /* Excel header green */
        color: #215732;
        border: 1px solid #217346;
        padding: 10px 5px;
        font-weight: bold;
    }
    
    .excel-style-calendar .calendar-day {
        border: 1px solid #b6d7a8;
        background-color: #ffffff;
    }
    
    .excel-style-calendar .calendar-date {
        color: #215732;
        font-weight: bold;
    }
    
    .excel-style-calendar .audit-entry {
        background-color: #e2f0d9;
        border-left: 2px solid #217346;
        margin: 2px 0;
    }
    
    .excel-style-calendar .today {
        background-color: #fff2cc; /* Light yellow for today */
    }
    
    .calendar-row {
        display: contents;
    }
    
    .calendar-heading {
        background-color: #f8f9fa;
        font-weight: bold;
        padding: 8px;
        text-align: center;
        border-bottom: 1px solid #dee2e6;
    }
    
    .calendar-day {
        min-height: 100px;
        border: 1px solid #dee2e6;
        padding: 4px;
        position: relative;
    }
    
    .calendar-date {
        font-weight: bold;
        text-align: right;
        margin-bottom: 4px;
        font-size: 0.85rem;
    }
    
    .calendar-entries {
        font-size: 0.75rem;
    }
    
    .audit-entry {
        margin-bottom: 4px;
        padding: 2px 4px;
        background-color: #e9ecef;
        border-radius: 3px;
        border-left: 3px solid #6c757d;
    }
    
    .audit-time {
        font-size: 0.7rem;
        color: #6c757d;
    }
    
    .audit-task {
        font-weight: 500;
    }
    
    .audit-user {
        font-size: 0.7rem;
        font-style: italic;
    }
    
    .today {
        background-color: #e8f4f8;
    }
    
    .machine-title {
        font-size: 1.25rem;
        font-weight: bold;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
    }
    
    .no-data {
        text-align: center;
        padding: 2rem;
        font-style: italic;
        color: #6c757d;
    }
    
    /* Print-specific styles */
    @media print {
        /* Reset any visibility problems */
        body * {
            visibility: visible !important;
        }
        
        .d-print-none {
            display: none !important;
            visibility: hidden !important;
        }
        
        .d-none.d-print-block {
            display: block !important;
            visibility: visible !important;
        }
        
        /* Excel-like calendar grid styles */
        .excel-calendar {
            display: table !important;
            width: 100% !important;
            border-collapse: collapse !important;
            table-layout: fixed !important;
            border: 2px solid #217346 !important; /* Excel green border */
            background: #fff !important;
        }
        
        .excel-calendar .calendar-row {
            display: table-row !important;
        }
        
        .excel-calendar .calendar-heading {
            display: table-cell !important;
            font-weight: bold !important;
            background-color: #d9ead3 !important; /* Excel header green */
            color: #215732 !important;
            border: 1px solid #217346 !important;
            text-align: center !important;
            font-size: 10pt !important;
            padding: 6px 0 !important;
        }
        
        .excel-calendar .calendar-day {
            display: table-cell !important;
            min-width: 80px !important;
            min-height: 70px !important;
            border: 1px solid #b6d7a8 !important;
            vertical-align: top !important;
            background: #fff !important;
            padding: 4px !important;
        }
        
        .excel-calendar .calendar-date {
            font-weight: bold !important;
            color: #215732 !important;
            text-align: right !important;
            font-size: 10pt !important;
            margin-bottom: 2px !important;
        }
        
        .excel-calendar .calendar-entries {
            font-size: 8pt !important;
        }
        
        .excel-calendar .audit-entry {
            margin: 2px 0 !important;
            padding: 2px 4px !important;
            background-color: #e2f0d9 !important;
            border-left: 2px solid #217346 !important;
        }
        
        .excel-calendar .today {
            background-color: #fff2cc !important;
        }
        
        /* Remove image/logo at top (if any) */
        .company-header img, .company-logo { 
            display: none !important; 
        }
        
        /* Print-specific layout */
        .print-header {
            margin-bottom: 1.5rem !important;
        }
        
        .company-info h1 {
            font-size: 18pt !important;
            margin-bottom: 0 !important;
        }
        
        .company-info p {
            font-size: 12pt !important;
            color: #555 !important;
        }
        
        .report-title h2 {
            font-size: 16pt !important;
            margin: 1rem 0 0.25rem 0 !important;
        }
        
        .report-id {
            font-size: 10pt !important;
            color: #666 !important;
        }
        
        .report-meta {
            display: flex !important;
            justify-content: space-between !important;
            margin: 1rem 0 !important;
        }
        
        .meta-table {
            border-collapse: collapse !important;
        }
        
        .meta-table th, .meta-table td {
            padding: 2px 8px !important;
            font-size: 9pt !important;
            text-align: left !important;
        }
        
        .meta-table th {
            font-weight: bold !important;
        }
        
        /* Page layout settings */
        @page {
            size: landscape !important;
            margin: 0.4in !important;
            margin-bottom: 0.6in !important;
        }
        
        /* Forcible page break between each machine */
        .machine-section {
            page-break-after: always !important;
            page-break-inside: avoid !important;
            display: block !important;
            width: 100% !important;
            margin-bottom: 1.5in !important; /* Space for the certification */
            position: relative !important;
        }
        
        .machine-section:last-child {
            page-break-after: auto !important;
        }
        
        /* Certification footer at bottom of each page */
        .certification-footer {
            position: fixed !important;
            bottom: 0.5in !important;
            left: 0.4in !important;
            right: 0.4in !important;
            font-size: 8pt !important;
            text-align: center !important;
            border-top: 1px solid #217346 !important;
            padding: 10px 0 !important;
            font-style: italic !important;
            color: #215732 !important;
        }
        
        /* Adjust parent containers */
        .content-container, .container, .container-fluid, .row, .col-12 {
            width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        /* Fix navbar and sidebar visibility in print */
        nav, .sidebar {
            display: none !important;
        }
    }
</style>
{% endblock %}