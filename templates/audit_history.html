{% extends "base.html" %}

{% block title %}Audit History - Maintenance Tracker{% endblock %}

{% block header_title %}Audit History{% endblock %}

{% block content %}
<!-- Flashed messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="container-fluid">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show mt-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if not (current_user.is_admin or (current_user.is_authenticated and current_user.role and (
    (hasattr(current_user.role, 'name') and 'audits.access' in (current_user.role.permissions or '')) or
    (not hasattr(current_user.role, 'name') and Role.query.filter_by(name=current_user.role).first() and 'audits.access' in (Role.query.filter_by(name=current_user.role).first().permissions or ''))
))) %}
  <div class="alert alert-warning text-center my-4" role="alert">
      <h4 class="alert-heading">Audits Feature Not Enabled</h4>
      <p>This feature is not available in your current plan. If you would like access to the Audits module, please contact <a href="mailto:sales@accuratemachinerepair.com">sales@accuratemachinerepair.com</a> for more information.</p>
  </div>
{% else %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4">Audit History</h2>
                <div class="d-print-none">
                    <button class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-1"></i> Print Report
                    </button>
                </div>
            </div>

            <!-- Filter Form -->
            <div class="card mb-4 d-print-none">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        {% if show_site_dropdown %}
                        <div class="col-md-3">
                            <label for="site_id" class="form-label">Site</label>
                            <select class="form-select" id="site_id" name="site_id" onchange="updateMachines(this.value)">
                                <option value="">All Sites</option>
                                {% for site in sites %}
                                <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% else %}
                        <!-- Hidden site_id field when only one site is available -->
                        <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
                        {% endif %}
                        
                        <div class="col-md-3">
                            <label for="machine_id" class="form-label">Machine</label>
                            <select class="form-select" id="machine_id" name="machine_id">
                                <option value="">All Machines</option>
                                {% for machine in available_machines %}
                                <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="start_date" class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ start_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %}">
                            <label for="end_date" class="form-label">End Date</label>
                            <input type="date" class="form-control" id="end_date" name="end_date" value="{{ end_date.strftime('%Y-%m-%d') }}">
                        </div>
                        
                        <div class="col-md-{% if show_site_dropdown %}2{% else %}3{% endif %} d-flex align-items-end">
                            <button type="submit" class="btn btn-success w-100">Apply Filters</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Enhanced Compact Print View (only visible when printing) -->
            <div class="d-none d-print-block">
                <!-- Company Header -->
                <div class="print-header">
                    <div class="company-header">
                        <div class="logo-section">
                            <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Company Logo" class="company-logo">
                        </div>
                        <div class="company-info">
                            <h1>Accurate Machine Repair Services</h1>
                            <p>Maintenance Tracking System</p>
                        </div>
                    </div>
                    
                    <!-- Report Title -->
                    <div class="report-title">
                        <h2>AUDIT HISTORY REPORT</h2>
                        <div class="report-id">Report #: AUD-{{ today.strftime('%Y%m%d') }}-{{ '%04d' % range(1, 10000)|random }}</div>
                    </div>
                    
                    <!-- Report Information -->
                    <div class="report-meta">
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Report Period:</th>
                                    <td>{{ start_date.strftime('%B %d, %Y') }} to {{ end_date.strftime('%B %d, %Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Site:</th>
                                    <td>
                                        {% if selected_site %}
                                            {{ sites|selectattr('id', 'eq', selected_site)|map(attribute='name')|list|first }}
                                        {% else %}
                                            All Sites
                                        {% endif %}
                                    </td>
                                </tr>
                                {% if selected_machine %}
                                <tr>
                                    <th>Machine:</th>
                                    <td>{{ available_machines|selectattr('id', 'eq', selected_machine)|map(attribute='name')|list|first }}</td>
                                </tr>
                                {% endif %}
                            </table>
                        </div>
                        <div class="report-section">
                            <table class="meta-table">
                                <tr>
                                    <th>Generated On:</th>
                                    <td>{{ today.strftime('%B %d, %Y') }}</td>
                                </tr>
                                <tr>
                                    <th>Generated By:</th>
                                    <td>{{ current_user.full_name or current_user.username }}</td>
                                </tr>
                                <tr>
                                    <th>Document Type:</th>
                                    <td>Official Audit Record</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Executive Summary -->
                <div class="executive-summary">
                    <h3>EXECUTIVE SUMMARY</h3>
                    <p>This report documents completed audit tasks within the specified date range. The data presented represents official records of maintenance audits conducted in accordance with operational regulations and internal compliance standards.</p>
                    
                    <div class="summary-metrics">
                        <div class="metric-box">
                            <span class="metric-value">{{ completions|length }}</span>
                            <span class="metric-label">Total Audits</span>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">{{ sorted_dates|length }}</span>
                            <span class="metric-label">Days with Activity</span>
                        </div>
                        <div class="metric-box">
                            <span class="metric-value">{{ completions|map(attribute='completed_by')|list|unique|list|length }}</span>
                            <span class="metric-label">Staff Members</span>
                        </div>
                    </div>
                </div>

                <!-- Calendar-like Machine-Organized Report Content -->
                {% if sorted_dates %}
                <div class="report-content">
                    <h3>CALENDAR VIEW BY MACHINE</h3>
                    
                    {% if selected_machine %}
                        <!-- Single machine view - organize by date -->
                        {% set machine_name = available_machines|selectattr('id', 'eq', selected_machine)|map(attribute='name')|list|first %}
                        <div class="machine-section">
                            <h4 class="machine-title">{{ machine_name }}</h4>
                            <div class="calendar-grid">
                                {% for date_str in sorted_dates %}
                                {% set date_obj = date_str.split('-') %}
                                <div class="calendar-day">
                                    <div class="calendar-date">
                                        {% if date_obj|length == 3 %}
                                            {{ date_obj[1] }}/{{ date_obj[2] }}/{{ date_obj[0] }}
                                        {% else %}
                                            {{ date_str }}
                                        {% endif %}
                                    </div>
                                    <div class="calendar-entries">
                                        {% for completion in grouped_completions[date_str] %}
                                            {% if completion.machine_id == selected_machine %}
                                            <div class="audit-entry">
                                                <div class="audit-time">{{ completion.completed_at.strftime('%H:%M') if completion.completed_at else '--' }}</div>
                                                <div class="audit-task">
                                                    {% if audit_tasks.get(completion.audit_task_id) %}
                                                        {{ audit_tasks.get(completion.audit_task_id).name }}
                                                    {% else %}
                                                        Unknown Task
                                                    {% endif %}
                                                </div>
                                                <div class="audit-user">
                                                    By: {% if users.get(completion.completed_by) %}
                                                        {{ users.get(completion.completed_by).full_name or users.get(completion.completed_by).username }}
                                                    {% else %}
                                                        Unknown User
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% else %}
                        <!-- Multi-machine view - organize first by machine, then by date -->
                        {% set machine_completions = {} %}
                        {% for completion in completions %}
                            {% set machine_id = completion.machine_id %}
                            {% if machine_id not in machine_completions %}
                                {% set _ = machine_completions.update({machine_id: []}) %}
                            {% endif %}
                            {% set _ = machine_completions[machine_id].append(completion) %}
                        {% endfor %}
                        
                        {% for machine_id, machine_audits in machine_completions.items() %}
                            {% if machines.get(machine_id) %}
                                <div class="machine-section">
                                    <h4 class="machine-title">{{ machines.get(machine_id).name }}</h4>
                                    
                                    {% set machine_dates = {} %}
                                    {% for completion in machine_audits %}
                                        {% set date_str = completion.date.strftime('%Y-%m-%d') %}
                                        {% if date_str not in machine_dates %}
                                            {% set _ = machine_dates.update({date_str: []}) %}
                                        {% endif %}
                                        {% set _ = machine_dates[date_str].append(completion) %}
                                    {% endfor %}
                                    
                                    <div class="calendar-grid">
                                        {% for date_str in machine_dates|sort(reverse=true) %}
                                            {% set date_obj = date_str.split('-') %}
                                            <div class="calendar-day">
                                                <div class="calendar-date">
                                                    {% if date_obj|length == 3 %}
                                                        {{ date_obj[1] }}/{{ date_obj[2] }}/{{ date_obj[0] }}
                                                    {% else %}
                                                        {{ date_str }}
                                                    {% endif %}
                                                </div>
                                                <div class="calendar-entries">
                                                    {% for completion in machine_dates[date_str] %}
                                                    <div class="audit-entry">
                                                        <div class="audit-time">{{ completion.completed_at.strftime('%H:%M') if completion.completed_at else '--' }}</div>
                                                        <div class="audit-task">
                                                            {% if audit_tasks.get(completion.audit_task_id) %}
                                                                {{ audit_tasks.get(completion.audit_task_id).name }}
                                                            {% else %}
                                                                Unknown Task
                                                            {% endif %}
                                                        </div>
                                                        <div class="audit-user">
                                                            By: {% if users.get(completion.completed_by) %}
                                                                {{ users.get(completion.completed_by).full_name or users.get(completion.completed_by).username }}
                                                            {% else %}
                                                                Unknown User
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
                {% else %}
                <div class="no-data">
                    <h3>NO AUDIT DATA AVAILABLE</h3>
                    <p>No audit history found for the selected date range
                    {% if selected_site %} and site{% endif %}
                    {% if selected_machine %} and machine{% endif %}.</p>
                </div>
                {% endif %}
                
                <!-- Certification Footer -->
                <div class="certification">
                    <h3>CERTIFICATION</h3>
                    <p>This report accurately reflects the audit activities recorded in the Maintenance Tracking System. The information contained herein has been generated automatically and constitutes an official record of maintenance compliance activities.</p>
                    
                    <div class="signatures">
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>System Administrator</p>
                        </div>
                        <div class="signature-block">
                            <div class="signature-line"></div>
                            <p>Compliance Officer</p>
                        </div>
                    </div>
                    
                    <div class="document-footer">
                        <p>Accurate Machine Repair Services &bull; Maintenance Tracking System</p>
                        <p>CONFIDENTIAL - FOR INTERNAL USE ONLY</p>
                        <p>Generated on {{ today.strftime('%Y-%m-%d %H:%M') }} by {{ current_user.username }}</p>
                        <div class="page-number">Page <span class="page"></span> of <span class="pages"></span></div>
                    </div>
                </div>
            </div>

            <!-- Screen View Content (hidden when printing) -->
            <div class="d-print-none">
                <!-- Results -->
                {% if sorted_dates %}
                    {% for date_str in sorted_dates %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h3 class="h5 mb-0">{{ date_str }}</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>Task</th>
                                            <th>Machine</th>
                                            <th>Completed By</th>
                                            <th>Time</th>
                                            <th>Site</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for completion in grouped_completions[date_str] %}
                                            <tr>
                                                <td>
                                                    {% if audit_tasks.get(completion.audit_task_id) %}
                                                        {{ audit_tasks.get(completion.audit_task_id).name }}
                                                        <span class="badge bg-secondary ms-1">
                                                            {% if audit_tasks.get(completion.audit_task_id).interval == 'custom' %}
                                                                Custom ({{ audit_tasks.get(completion.audit_task_id).custom_interval_days }} days)
                                                            {% else %}
                                                                {{ audit_tasks.get(completion.audit_task_id).interval|capitalize }}
                                                            {% endif %}
                                                        </span>
                                                    {% else %}
                                                        Unknown Task
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if machines.get(completion.machine_id) %}
                                                        {{ machines.get(completion.machine_id).name }}
                                                    {% else %}
                                                        Unknown Machine
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if users.get(completion.completed_by) %}
                                                        {{ users.get(completion.completed_by).full_name or users.get(completion.completed_by).username }}
                                                    {% else %}
                                                        Unknown User
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if completion.completed_at %}
                                                        {{ completion.completed_at.strftime('%H:%M') }}
                                                    {% else %}
                                                        --
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if audit_tasks.get(completion.audit_task_id) %}
                                                        {% set task = audit_tasks.get(completion.audit_task_id) %}
                                                        {% for site in sites if site.id == task.site_id %}
                                                            {{ site.name }}
                                                        {% endfor %}
                                                    {% else %}
                                                        Unknown Site
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="alert alert-info">
                        No audit history found for the selected date range
                        {% if selected_site %} and site{% endif %}
                        {% if selected_machine %} and machine{% endif %}.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    // Store machine data in a JavaScript variable
    // This completely separates Jinja template logic from JavaScript
    var machineData = [
        {% for machine in available_machines %}
            {% if machine.site_id is defined %}
            {
                id: "{{ machine.id }}",
                name: "{{ machine.name|replace('"', '\\"')|replace("'", "\\'") }}",
                siteId: "{{ machine.site_id }}"
            }{% if not loop.last %},{% endif %}
            {% endif %}
        {% endfor %}
    ];
    
    // Store the selected values in JavaScript variables
    var selectedSiteId = "{{ sites[0].id if sites and not show_site_dropdown else selected_site|default('') }}";
    var selectedMachineId = "{{ selected_machine|default('') }}";
    
    // Function to update available machines when site selection changes
    function updateMachines(siteId) {
        // Get the machine dropdown
        const machineDropdown = document.getElementById('machine_id');
        
        // Clear current options except for the "All Machines" option
        while (machineDropdown.options.length > 1) {
            machineDropdown.remove(1);
        }
        
        // If no site selected, we're done (keep just "All Machines" option)
        if (!siteId) {
            return;
        }
        
        // Add machines for the selected site
        machineData.forEach(function(machine) {
            if (machine.siteId === siteId) {
                const option = document.createElement('option');
                option.value = machine.id;
                option.text = machine.name;
                machineDropdown.add(option);
            }
        });
        
        // If we have a previously selected machine, try to restore it
        if (selectedMachineId) {
            for (let i = 0; i < machineDropdown.options.length; i++) {
                if (machineDropdown.options[i].value === selectedMachineId) {
                    machineDropdown.selectedIndex = i;
                    break;
                }
            }
        }
    }
    
    // Initialize the machine dropdown when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        const siteDropdown = document.getElementById('site_id');
        if (siteDropdown && siteDropdown.value) {
            updateMachines(siteDropdown.value);
        }
    });

    // Enhanced print handling
    window.onbeforeprint = function() {
        // Force page to landscape orientation
        const forceLandscape = document.createElement('style');
        forceLandscape.type = 'text/css';
        forceLandscape.innerHTML = `
            @page { size: landscape !important; margin: 0.4in !important; }
            
            .page::after { content: counter(page); }
            .pages::after { content: counter(pages); }
            
            /* Force grid display in WebKit browsers */
            .calendar-grid {
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
                width: 100% !important;
            }
            
            /* Ensure color backgrounds print */
            .calendar-date, .machine-title, .executive-summary {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            /* Last minute fixes for print mode */
            @media print {
                body * {
                    visibility: hidden !important;
                }
                
                .d-none.d-print-block, 
                .d-none.d-print-block * {
                    visibility: visible !important;
                    display: block !important;
                }
                
                html body .content-container {
                    margin-left: 0 !important;
                    width: 100% !important;
                    max-width: 100% !important;
                }
            }
        `;
        document.head.appendChild(forceLandscape);
        
        // Make specific adjustments to DOM elements for printing
        const calendarGrids = document.querySelectorAll('.calendar-grid');
        calendarGrids.forEach(function(grid) {
            grid.style.setProperty('display', 'grid', 'important');
            grid.style.setProperty('grid-template-columns', 'repeat(3, 1fr)', 'important');
            grid.style.setProperty('width', '100%', 'important');
        });
    };
</script>
{% endblock %}

{% block styles %}
<style>
    /* Regular styles remain unchanged */
    
    /* Professional Print Styling with Calendar Layout */
    @media print {
        /* Force landscape orientation */
        @page {
            size: landscape !important;
            margin: 0.4in !important;
        }
        
        /* Reset body styles */
        html, body {
            width: 100% !important;
            height: auto !important;
            margin: 0 !important;
            padding: 0 !important;
            overflow: visible !important;
            font-family: Arial, Helvetica, sans-serif !important;
            font-size: 10pt !important;
            line-height: 1.3 !important;
            color: #000 !important;
            background: #fff !important;
            display: block !important;
            position: static !important; 
        }
        
        /* Aggressively hide page elements */
        header, .navbar, nav, .sidebar, .sidebar-container, .sidebar-nav, .footer,
        .d-print-none, .page-header, #hamburger-btn, .sidebar-toggle-btn,
        .centered-layout > .row > .col-md-auto {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
            margin: 0 !important;
            padding: 0 !important;
            position: absolute !important; 
            left: -9999px !important;
            visibility: hidden !important;
            overflow: hidden !important;
        }
        
        /* Force full page width for content */
        .content-container, .centered-content-col, .container-fluid, .row, .col,
        .col-12, .centered-layout, .page-content {
            display: block !important;
            width: 100% !important;
            max-width: 100% !important;
            margin: 0 !important;
            padding: 0 !important;
            margin-left: 0 !important;
            left: 0 !important;
            position: static !important;
        }
        
        /* Show print-only elements */
        .d-none.d-print-block {
            display: block !important;
            width: 100% !important;
        }
        
        /* Company Header */
        .print-header {
            margin-bottom: 15px !important;
            display: block !important;
        }
        
        .company-header {
            display: flex !important;
            justify-content: space-between !important;
            align-items: center !important;
            margin-bottom: 15px !important;
            border-bottom: 2px solid #2c3e50 !important;
            padding-bottom: 8px !important;
        }
        
        .company-logo {
            height: 50px !important;
            width: auto !important;
        }
        
        .company-info {
            text-align: right !important;
        }
        
        .company-info h1 {
            font-size: 16pt !important;
            font-weight: bold !important;
            margin: 0 !important;
            color: #2c3e50 !important;
        }
        
        .company-info p {
            font-size: 10pt !important;
            margin: 0 !important;
            color: #7f8c8d !important;
        }
        
        /* Report Title */
        .report-title {
            text-align: center !important;
            margin-bottom: 15px !important;
            position: relative !important;
        }
        
        .report-title h2 {
            font-size: 14pt !important;
            font-weight: bold !important;
            text-transform: uppercase !important;
            margin: 0 !important;
            padding: 8px 0 !important;
            color: #2c3e50 !important;
            border-bottom: 1px solid #bdc3c7 !important;
            border-top: 1px solid #bdc3c7 !important;
        }
        
        .report-id {
            position: absolute !important;
            top: 0 !important;
            right: 0 !important;
            font-size: 9pt !important;
            color: #7f8c8d !important;
        }
        
        /* Report Meta Information */
        .report-meta {
            display: flex !important;
            justify-content: space-between !important;
            margin-bottom: 20px !important;
            font-size: 9pt !important;
        }
        
        .report-section {
            width: 48% !important;
        }
        
        .meta-table {
            width: 100% !important;
            border-collapse: collapse !important;
        }
        
        .meta-table th {
            text-align: left !important;
            padding: 4px !important;
            font-weight: bold !important;
            width: 35% !important;
            vertical-align: top !important;
        }
        
        .meta-table td {
            padding: 4px !important;
            border-bottom: 1px dotted #ddd !important;
        }
        
        /* Executive Summary */
        .executive-summary {
            margin-bottom: 15px !important;
            padding: 10px !important;
            background-color: #f8f9fa !important;
            border: 1px solid #ddd !important;
            border-radius: 5px !important;
            display: block !important;
        }
        
        .executive-summary h3 {
            font-size: 12pt !important;
            margin: 0 0 8px 0 !important;
            color: #2c3e50 !important;
            border-bottom: 1px solid #ddd !important;
            padding-bottom: 4px !important;
        }
        
        .executive-summary p {
            margin: 0 0 8px 0 !important;
            font-size: 9pt !important;
        }
        
        .summary-metrics {
            display: flex !important;
            justify-content: space-around !important;
            margin-top: 10px !important;
        }
        
        .metric-box {
            text-align: center !important;
            padding: 8px !important;
            background-color: #fff !important;
            border: 1px solid #ddd !important;
            border-radius: 5px !important;
            width: 30% !important;
        }
        
        .metric-value {
            display: block !important;
            font-size: 18pt !important;
            font-weight: bold !important;
            color: #16a085 !important;
        }
        
        .metric-label {
            display: block !important;
            font-size: 8pt !important;
            color: #7f8c8d !important;
            text-transform: uppercase !important;
        }
        
        /* Calendar Layout Styling */
        .report-content {
            margin-bottom: 20px !important;
            display: block !important;
            page-break-before: avoid !important;
        }
        
        .report-content h3 {
            font-size: 12pt !important;
            margin: 0 0 10px 0 !important;
            color: #2c3e50 !important;
            border-bottom: 1px solid #ddd !important;
            padding-bottom: 5px !important;
            text-align: center !important;
        }
        
        .machine-section {
            margin-bottom: 20px !important;
            page-break-inside: avoid !important;
            display: block !important;
        }
        
        .machine-title {
            font-size: 11pt !important;
            margin: 0 0 8px 0 !important;
            padding: 4px 8px !important;
            background-color: #34495e !important;
            color: #fff !important;
            border-radius: 4px !important;
        }
        
        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(3, 1fr) !important;
            gap: 8px !important;
            margin-bottom: 15px !important;
        }
        
        .calendar-day {
            border: 1px solid #ddd !important;
            border-radius: 4px !important;
            overflow: hidden !important;
            background-color: #fff !important;
            break-inside: avoid !important;
            page-break-inside: avoid !important;
        }
        
        .calendar-date {
            background-color: #ecf0f1 !important;
            padding: 3px 6px !important;
            font-weight: bold !important;
            font-size: 9pt !important;
            border-bottom: 1px solid #ddd !important;
        }
        
        .calendar-entries {
            padding: 0 !important;
            max-height: 180px !important;
            overflow: hidden !important;
        }
        
        .audit-entry {
            padding: 5px !important;
            border-bottom: 1px dotted #ddd !important;
            font-size: 8.5pt !important;
        }
        
        .audit-entry:last-child {
            border-bottom: none !important;
        }
        
        .audit-time {
            font-weight: bold !important;
            color: #3498db !important;
        }
        
        .audit-task {
            font-weight: bold !important;
            margin: 2px 0 !important;
        }
        
        .audit-user {
            font-size: 8pt !important;
            color: #7f8c8d !important;
        }
        
        /* No Data Message */
        .no-data {
            text-align: center !important;
            padding: 20px !important;
            margin: 15px 0 !important;
            border: 1px dashed #bdc3c7 !important;
            background-color: #f8f9fa !important;
        }
        
        .no-data h3 {
            font-size: 12pt !important;
            color: #e74c3c !important;
            margin: 0 0 8px 0 !important;
        }
        
        .no-data p {
            color: #7f8c8d !important;
            margin: 0 !important;
        }
        
        /* Certification Footer */
        .certification {
            margin-top: 20px !important;
            border-top: 1px solid #bdc3c7 !important;
            padding-top: 15px !important;
            page-break-before: auto !important;
            page-break-inside: avoid !important;
            display: block !important;
        }
        
        .certification h3 {
            font-size: 11pt !important;
            margin: 0 0 8px 0 !important;
            color: #2c3e50 !important;
        }
        
        .certification p {
            font-size: 8pt !important;
            margin: 0 0 12px 0 !important;
        }
        
        .signatures {
            display: flex !important;
            justify-content: space-around !important;
            margin: 20px 0 !important;
        }
        
        .signature-block {
            width: 40% !important;
            text-align: center !important;
        }
        
        .signature-line {
            border-bottom: 1px solid #000 !important;
            height: 30px !important;
            margin-bottom: 4px !important;
        }
        
        .signature-block p {
            margin: 0 !important;
            font-size: 8pt !important;
        }
        
        .document-footer {
            margin-top: 20px !important;
            text-align: center !important;
            font-size: 7pt !important;
            color: #7f8c8d !important;
            border-top: 1px solid #bdc3c7 !important;
            padding-top: 8px !important;
        }
        
        .document-footer p {
            margin: 2px 0 !important;
        }
        
        .page-number {
            margin-top: 5px !important;
        }
        
        /* Force page breaks between machine sections */
        .machine-section + .machine-section {
            page-break-before: always !important;
        }
    }
</style>

{% endblock %}