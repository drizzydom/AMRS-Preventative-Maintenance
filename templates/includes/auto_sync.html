<!-- Auto-sync JavaScript for offline clients -->
<script>
// Auto-sync functionality for offline clients
(function() {
    'use strict';
    
    let syncInProgress = false;
    let lastSyncTime = 0;
    const SYNC_COOLDOWN = 5000; // 5 seconds between syncs
    
    function isOnline() {
        return navigator.onLine;
    }
    
    function shouldTriggerSync() {
        const now = Date.now();
        return !syncInProgress && 
               isOnline() && 
               (now - lastSyncTime) > SYNC_COOLDOWN;
    }
    
    function triggerManualSync() {
        if (!shouldTriggerSync()) {
            console.log('[SYNC] Skipping sync: conditions not met');
            return Promise.resolve({status: 'skipped'});
        }
        
        syncInProgress = true;
        lastSyncTime = Date.now();
        
        console.log('[SYNC] Triggering manual sync...');
        
        return fetch('/api/sync/trigger', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            console.log('[SYNC] Manual sync result:', data);
            if (data.status === 'triggered' && data.pending_count > 0) {
                // Show subtle notification
                showSyncNotification(`Uploading ${data.pending_count} changes...`, 'info');
            }
            return data;
        })
        .catch(error => {
            console.error('[SYNC] Manual sync failed:', error);
            // Don't show error to user for sync failures - this should be silent
            return {status: 'error', error: error.message};
        })
        .finally(() => {
            syncInProgress = false;
        });
    }
    
    function showSyncNotification(message, type = 'info') {
        // Create a subtle notification that doesn't interfere with normal operation
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = `
            top: 10px; 
            right: 10px; 
            z-index: 9999; 
            max-width: 300px; 
            font-size: 0.875rem;
            opacity: 0.9;
        `;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(notification);
        
        // Auto-remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 3000);
    }
    
    function initAutoSync() {
        // Trigger sync on page load (with delay to not interfere with page loading)
        setTimeout(() => {
            if (isOnline()) {
                triggerManualSync();
            }
        }, 1000);
        
        // Trigger sync when coming back online
        window.addEventListener('online', () => {
            console.log('[SYNC] Device back online, triggering sync...');
            setTimeout(triggerManualSync, 500);
        });
        
        // Optional: Trigger sync on visibility change (when user returns to tab)
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden && isOnline()) {
                setTimeout(triggerManualSync, 1000);
            }
        });
        
        // Optional: Trigger sync on focus (when user clicks back to window)
        window.addEventListener('focus', () => {
            if (isOnline()) {
                setTimeout(triggerManualSync, 1000);
            }
        });
    }
    
    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initAutoSync);
    } else {
        initAutoSync();
    }
    
    // Expose triggerManualSync globally for manual triggering
    window.triggerManualSync = triggerManualSync;
    
    console.log('[SYNC] Auto-sync system initialized');
})();
</script>
