{% extends "base.html" %}

{% block title %}Manage Roles - Maintenance Tracker{% endblock %}

{% block header_title %}Manage Roles{% endblock %}

{% block content %}
<div class="roles-management">
    <!-- Add new role card -->
    <div class="card mb-4">
        <div class="card-header">
            <h3>Add New Role</h3>
        </div>
        <div class="card-body">
            <form method="POST" class="add-role-form">
                <div class="row">
                    <div class="col">
                        <div class="form-group">
                            <label for="name" class="form-label">Role Name</label>
                            <input type="text" id="name" name="name" class="form-control" required>
                        </div>
                    </div>
                    <div class="col">
                        <div class="form-group">
                            <label for="description" class="form-label">Description</label>
                            <input type="text" id="description" name="description" class="form-control">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Permissions</label>
                    <div class="permissions-container" style="max-height: 400px; overflow-y: auto; padding: 1rem; border: 1px solid var(--gray-200); border-radius: 0.375rem;">
                        <div class="row">
                            <!-- User Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">User Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_users_view" name="permissions" value="users.view">
                                        <label for="perm_users_view" class="form-label mb-0">View Users</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_users_create" name="permissions" value="users.create">
                                        <label for="perm_users_create" class="form-label mb-0">Create Users</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_users_edit" name="permissions" value="users.edit">
                                        <label for="perm_users_edit" class="form-label mb-0">Edit Users</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_users_delete" name="permissions" value="users.delete">
                                        <label for="perm_users_delete" class="form-label mb-0">Delete Users</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Role Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Role Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_roles_view" name="permissions" value="roles.view">
                                        <label for="perm_roles_view" class="form-label mb-0">View Roles</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_roles_create" name="permissions" value="roles.create">
                                        <label for="perm_roles_create" class="form-label mb-0">Create Roles</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_roles_edit" name="permissions" value="roles.edit">
                                        <label for="perm_roles_edit" class="form-label mb-0">Edit Roles</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_roles_delete" name="permissions" value="roles.delete">
                                        <label for="perm_roles_delete" class="form-label mb-0">Delete Roles</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <!-- Site Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Site Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_sites_view" name="permissions" value="sites.view">
                                        <label for="perm_sites_view" class="form-label mb-0">View All Sites</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_sites_view_assigned" name="permissions" value="sites.view.assigned">
                                        <label for="perm_sites_view_assigned" class="form-label mb-0">View Only Assigned Sites</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_sites_create" name="permissions" value="sites.create">
                                        <label for="perm_sites_create" class="form-label mb-0">Create Sites</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_sites_edit" name="permissions" value="sites.edit">
                                        <label for="perm_sites_edit" class="form-label mb-0">Edit Sites</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_sites_delete" name="permissions" value="sites.delete">
                                        <label for="perm_sites_delete" class="form-label mb-0">Delete Sites</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Machine Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Machine Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_machines_view" name="permissions" value="machines.view">
                                        <label for="perm_machines_view" class="form-label mb-0">View Machines</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_machines_create" name="permissions" value="machines.create">
                                        <label for="perm_machines_create" class="form-label mb-0">Create Machines</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_machines_edit" name="permissions" value="machines.edit">
                                        <label for="perm_machines_edit" class="form-label mb-0">Edit Machines</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_machines_delete" name="permissions" value="machines.delete">
                                        <label for="perm_machines_delete" class="form-label mb-0">Delete Machines</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <!-- Part Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Part Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_parts_view" name="permissions" value="parts.view">
                                        <label for="perm_parts_view" class="form-label mb-0">View Parts</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_parts_create" name="permissions" value="parts.create">
                                        <label for="perm_parts_create" class="form-label mb-0">Create Parts</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_parts_edit" name="permissions" value="parts.edit">
                                        <label for="perm_parts_edit" class="form-label mb-0">Edit Parts</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_parts_delete" name="permissions" value="parts.delete">
                                        <label for="perm_parts_delete" class="form-label mb-0">Delete Parts</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Maintenance Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Maintenance Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_maintenance_view" name="permissions" value="maintenance.view">
                                        <label for="perm_maintenance_view" class="form-label mb-0">View Maintenance</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_maintenance_schedule" name="permissions" value="maintenance.schedule">
                                        <label for="perm_maintenance_schedule" class="form-label mb-0">Schedule Maintenance</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_maintenance_record" name="permissions" value="maintenance.record">
                                        <label for="perm_maintenance_record" class="form-label mb-0">Record Maintenance</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mt-3">
                            <!-- Backup Management Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Backup Management</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_backup_view" name="permissions" value="backup.view">
                                        <label for="perm_backup_view" class="form-label mb-0">View Backups</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_backup_create" name="permissions" value="backup.create">
                                        <label for="perm_backup_create" class="form-label mb-0">Create Backups</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_backup_restore" name="permissions" value="backup.restore">
                                        <label for="perm_backup_restore" class="form-label mb-0">Restore Backups</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_backup_delete" name="permissions" value="backup.delete">
                                        <label for="perm_backup_delete" class="form-label mb-0">Delete Backups</label>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Administration Permissions -->
                            <div class="col">
                                <h4 class="permission-category">Administration</h4>
                                <div class="permission-group">
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_admin_access" name="permissions" value="admin.access">
                                        <label for="perm_admin_access" class="form-label mb-0">Admin Panel Access</label>
                                    </div>
                                    <div class="permission-item">
                                        <input type="checkbox" id="perm_admin_full" name="permissions" value="admin.full">
                                        <label for="perm_admin_full" class="form-label mb-0">Full Administrative Access</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary mt-3">
                    <i class="fas fa-plus"></i> Add Role
                </button>
            </form>
        </div>
    </div>
    
    <!-- Roles list card -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Role List</h3>
            <div class="header-actions">
                <div class="form-group mb-0" style="width: 200px;">
                    <input type="text" id="roleSearch" class="form-control" placeholder="Search roles...">
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if roles %}
                <div class="table-container">
                    <table class="table" id="rolesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Permissions</th>
                                <th>Users</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for role in roles %}
                            <tr>
                                <td>{{ role.name }}</td>
                                <td>{{ role.description }}</td>
                                <td>
                                    <div class="permission-badges">
                                        {% for permission in role.get_permissions_list() %}
                                        <span class="status-badge status-info">{{ permission }}</span>
                                        {% endfor %}
                                    </div>
                                </td>
                                <td>{{ role.users|length }}</td>
                                <td>
                                    <div class="d-flex gap-2">
                                        <a href="{{ url_for('edit_role', role_id=role.id) }}" class="btn btn-sm btn-primary">
                                            <i class="fas fa-edit"></i> Edit
                                        </a>
                                        <form action="{{ url_for('delete_role', role_id=role.id) }}" method="POST" 
                                              onsubmit="return confirm('Are you sure you want to delete this role? This could affect users assigned to this role.');">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash-alt"></i> Delete
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    No roles have been added yet. Use the form above to add your first role.
                </div>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .permission-category {
        font-size: 1rem;
        font-weight: 600;
        color: var(--gray-700);
        margin-bottom: 0.75rem;
        padding-bottom: 0.25rem;
        border-bottom: 1px solid var(--gray-200);
    }
    
    .permission-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .permission-item {
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
    }
    
    .permission-item input[type="checkbox"] {
        margin-right: 0.5rem;
    }
    
    .permission-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 0.25rem;
    }
    
    .status-badge.status-info {
        background-color: rgba(6, 182, 212, 0.1);
        color: #0891b2;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add search functionality
        const searchInput = document.getElementById('roleSearch');
        if (searchInput) {
            searchInput.addEventListener('keyup', function() {
                const searchTerm = this.value.toLowerCase();
                const table = document.getElementById('rolesTable');
                const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                
                for (let i = 0; i < rows.length; i++) {
                    let found = false;
                    const cells = rows[i].getElementsByTagName('td');
                    
                    for (let j = 0; j < cells.length - 1; j++) { // Skip the last cell (Actions)
                        const cellText = cells[j].textContent.toLowerCase();
                        if (cellText.indexOf(searchTerm) > -1) {
                            found = true;
                            break;
                        }
                    }
                    
                    if (found) {
                        rows[i].style.display = '';
                    } else {
                        rows[i].style.display = 'none';
                    }
                }
            });
        }
    });
</script>
{% endblock %}
