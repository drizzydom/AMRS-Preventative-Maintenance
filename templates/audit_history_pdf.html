<!DOCTYPE html>
<html>
<head>
    <title>Audit History Report</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin-bottom: 5px;
        }
        .report-info {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 5px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .machine-header {
            background-color: #4A6572;
            color: white;
            padding: 10px;
            margin-top: 30px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .date-header {
            background-color: #6B818C;
            color: white;
            padding: 8px;
            margin-top: 15px;
            margin-bottom: 10px;
            border-radius: 3px;
        }
        .footer {
            margin-top: 30px;
            text-align: center;
            font-size: 0.8em;
            color: #777;
        }
        .calendar {
            width: 100%;
            margin-bottom: 30px;
        }
        .calendar th {
            text-align: center;
            padding: 5px;
        }
        .calendar td {
            height: 40px;
            width: 14.28%;
            vertical-align: top;
            padding: 5px;
            position: relative;
        }
        .calendar .day-number {
            font-weight: bold;
        }
        .calendar .outside-month {
            background-color: #f5f5f5;
            color: #aaa;
        }
        .calendar .has-audit {
            background-color: #d4edda;
        }
        .audit-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #28a745;
            margin-right: 3px;
        }
        .task-status {
            font-size: 0.9em;
            margin-bottom: 2px;
        }
        .task-status.pass {
            color: #28a745;
        }
        .task-status.fail {
            color: #dc3545;
        }
        .task-status.skip {
            color: #ffc107;
        }
        @page {
            size: letter;
            margin: 2cm;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Audit History Report</h1>
        <p>Generated on {{ today.strftime('%B %d, %Y at %H:%M') }}</p>
    </div>

    <div class="report-info">
        <p><strong>Date Range:</strong> {{ start_date.strftime('%B %d, %Y') }} to {{ end_date.strftime('%B %d, %Y') }}</p>
        <p><strong>Generated by:</strong> {{ current_user.first_name }} {{ current_user.last_name }}</p>
    </div>

    <h2>Monthly Calendar View</h2>
    
    {% for machine in machines %}
    <div class="machine-header">
        <h3>{{ machine.name }} ({{ machine.site.name if machine.site else 'No Site' }})</h3>
    </div>

    <!-- Add legend for all assigned tasks -->
    <div class="legend-items" style="margin-bottom: 20px;">
      {% for task in all_tasks_per_machine[machine.id] %}
        <span style="display:inline-block; margin-right:10px;">
          <span style="display:inline-block; width:14px; height:14px; border-radius:50%; background-color:#ccc; vertical-align:middle; margin-right:4px; background-color:{% if task.category == 'electrical' %}#dc3545{% elif task.category == 'mechanical' %}#0d6efd{% elif task.category == 'hydraulic' %}#fd7e14{% elif task.category == 'pneumatic' %}#6f42c1{% elif task.category == 'general' %}#198754{% elif task.category == 'electronic' %}#20c997{% elif task.category == 'structural' %}#6c757d{% else %}#ccc{% endif %}; opacity:0.7;"></span>
          <span style="font-size:0.95em;">{{ task.name }}</span>
        </span>
      {% endfor %}
    </div>

    {% set machine_start_date = start_date.replace(day=1) %}
    {% set machine_end_date = (end_date.replace(day=1) + timedelta(days=32)).replace(day=1) - timedelta(days=1) %}
    
    <table class="calendar">
        <thead>
            <tr>
                <th>Sunday</th>
                <th>Monday</th>
                <th>Tuesday</th>
                <th>Wednesday</th>
                <th>Thursday</th>
                <th>Friday</th>
                <th>Saturday</th>
            </tr>
        </thead>
        <tbody>
            {% for week in get_calendar_weeks(machine_start_date, machine_end_date) %}
                <tr>
                    {% for day in week %}
                        {% set day_str = day.strftime('%Y-%m-%d') %}
                        {% set has_audit = machine.id in machine_data and day_str in machine_data[machine.id] %}
                        <td class="{{ 'outside-month' if day.month != start_date.month and day.month != end_date.month else '' }} {{ 'has-audit' if has_audit else '' }}">
                            <div class="day-number">{{ day.day }}</div>
                            {% if has_audit %}
                                {% for completion in machine_data[machine.id][day_str] %}
                                    <div class="task-status {{ completion.status }}">
                                        <span class="audit-dot"></span>
                                        {{ audit_tasks[completion.audit_task_id].name if completion.audit_task_id in audit_tasks else 'Unknown Task' }}
                                    </div>
                                {% endfor %}
                            {% endif %}
                            <!-- Render interval bars in the calendar -->
                            {% for task in all_tasks_per_machine[machine.id] %}
                                {% if interval_bars[machine.id][task.id] %}
                                    {% for bar in interval_bars[machine.id][task.id] %}
                                        {% set bar_start = bar[0] %}
                                        {% set bar_end = bar[1] %}
                                        {% if day >= bar_start and day <= bar_end %}
                                            <div style="height:7px; border-radius:4px; width:100%; position:absolute; left:0; bottom:0; opacity:0.3; background-color:{% if task.category == 'electrical' %}#dc3545{% elif task.category == 'mechanical' %}#0d6efd{% elif task.category == 'hydraulic' %}#fd7e14{% elif task.category == 'pneumatic' %}#6f42c1{% elif task.category == 'general' %}#198754{% elif task.category == 'electronic' %}#20c997{% elif task.category == 'structural' %}#6c757d{% else %}#ccc{% endif %};"></div>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                        </td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>Detailed Audit Records</h3>
    {% if machine.id in machine_data %}
        {% for date_str, completions in machine_data[machine.id].items()|sort(reverse=True) %}
            <div class="date-header">
                <h4>{{ datetime.strptime(date_str, '%Y-%m-%d').strftime('%B %d, %Y') }}</h4>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Completed By</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for completion in completions %}
                        <tr>
                            <td>{{ audit_tasks[completion.audit_task_id].name if completion.audit_task_id in audit_tasks else 'Unknown Task' }}</td>
                            <td>{{ completion.status|upper }}</td>
                            <td>{{ users[completion.user_id].first_name }} {{ users[completion.user_id].last_name if completion.user_id in users else 'Unknown User' }}</td>
                            <td>{{ completion.notes if completion.notes else '-' }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% endfor %}
    {% else %}
        <p>No audit records found for this machine in the selected date range.</p>
    {% endif %}
    {% endfor %}

    <div class="footer">
        <p>AMRS Preventative Maintenance System &mdash; Confidential</p>
    </div>
</body>
</html>