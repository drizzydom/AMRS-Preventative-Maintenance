{% extends "base.html" %}
{% block title %}Maintenance Records{% endblock %}
{% block header_title %}Maintenance Records{% endblock %}
{% block content %}
<div class="card">
    <div class="card-body">
        <h2 class="mb-4">Maintenance Records</h2>
        <form method="get" class="row g-3 mb-4">
            {% if sites|length > 1 %}
            <div class="col-md-4">
                <label for="site_id" class="form-label">Site</label>
                <select class="form-select" id="site_id" name="site_id" onchange="this.form.submit()">
                    <option value="">All Sites</option>
                    {% for site in sites %}
                    <option value="{{ site.id }}" {% if selected_site == site.id %}selected{% endif %}>{{ site.name }}</option>
                    {% endfor %}
                </select>
            </div>
            {% else %}
            <!-- For single site users, add a hidden field to ensure filtering works -->
            <input type="hidden" id="site_id" name="site_id" value="{{ sites[0].id if sites else '' }}">
            {% endif %}
            <div class="col-md-{% if sites|length > 1 %}4{% else %}6{% endif %}">
                <label for="machine_id" class="form-label">Machine</label>
                <select class="form-select" id="machine_id" name="machine_id" onchange="this.form.submit()">
                    <option value="">All Machines</option>
                    {% for machine in machines %}
                    <option value="{{ machine.id }}" {% if selected_machine == machine.id %}selected{% endif %}>{{ machine.name }}{% if machine.machine_number %} ({{ machine.machine_number }}){% elif machine.serial_number %} (SN: {{ machine.serial_number }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-{% if sites|length > 1 %}4{% else %}6{% endif %}">
                <label for="part_id" class="form-label">Part</label>
                <select class="form-select" id="part_id" name="part_id" onchange="this.form.submit()">
                    <option value="">All Parts</option>
                    {% for part in parts %}
                    <option value="{{ part.id }}" {% if selected_part == part.id %}selected{% endif %}>{{ part.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </form>
        {% if records %}
        <div class="table-responsive">
            <span class="table-scroll-hint d-md-none">Scroll &rarr; for more columns</span>
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Machine</th>
                        <th>Maintenance Type</th>
                        <th>Description</th>
                        <th>Date Performed</th>
                        <th>User</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in records %}
                    <tr>
                        <td>{{ record.machine.name }}</td>
                        <td>{{ record.maintenance_type }}</td>
                        <td>{{ record.description }}</td>
                        <td>{{ record.date_performed.strftime('%Y-%m-%d') }}</td>
                        <td>{{ record.user.username }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif selected_part %}
        <div class="alert alert-info mt-4">No maintenance records found for this part.</div>
        {% endif %}
    </div>
</div>
{% endblock %}
